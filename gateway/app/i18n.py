from __future__ import annotations

import os
from typing import Any, Dict
from starlette.requests import Request

SUPPORTED_UI_LOCALES = ["zh", "mm"]
DEFAULT_UI_LOCALE = os.getenv("DEFAULT_UI_LOCALE", "zh").strip().lower() or "zh"
STRICT_OPERATOR_LOCALE = os.getenv("STRICT_OPERATOR_LOCALE", "true").lower() in {
    "1",
    "true",
    "yes",
    "on",
}

I18N_DICT: Dict[str, Dict[str, str]] = {
    "zh": {
        "lang.zh": "中文",
        "lang.mm": "缅文",
        "id": "ID",
        "platform": "平台",
        "source": "来源",
        "title": "标题",
        "category": "分类",
        "lang": "语种",
        "status": "状态",
        "created": "创建时间",
        "pack": "剪辑包",
        "publish": "发布",
        "detail": "详情",
        "download": "下载",
        "open": "打开",
        "json": "JSON",
        "delete": "删除",
        "legend": "图例",
        "new_suitcase_task": "新建任务",
        "status_ready": "已就绪",
        "status_processing": "处理中",
        "status_pending": "排队中",
        "status_error": "失败",
        "status_unknown": "未知",
        "category_suitcase": "Suitcase",
        "category_beauty": "Beauty",
        "category_other": "其他",
        "task_count": "任务数量",
        "no_tasks": "暂无任务",
        "nav.tasks": "任务",
        "nav.tools": "工具",
        "page.tasks.board.title": "任务看板",
        "page.tasks.board.subtitle": "已加载 {count} 个任务",
        "page.tasks.new.title": "新建任务",
        "page.tasks.new.subtitle": "粘贴链接 → 一键生成 Smart Pack + README",
        "page.tools.hub.title": "工具中心",
        "page.tools.hub.subtitle": "工具配置与入口（SSOT）",
        "page.tools.detail.title": "工具详情",
        "page.workbench.title": "工作台",
        "page.workbench.subtitle": "任务ID: {task_id}",
        "page.publish.title": "发布中心",
        "page.publish.subtitle": "任务ID: {task_id}",
        "action.new_task": "新建任务",
        "action.refresh": "刷新",
        "action.back_tasks": "任务看板",
        "action.back_tools": "工具中心",
        "action.open": "打开",
        "action.download": "下载",
        "action.copy": "复制",
        "action.save": "保存",
        "action.submit": "提交",
        "action.unlock": "解锁",
        "action.create": "创建并运行",
        "action.reset": "重置",
        "action.run": "运行",
        "status.ready": "已就绪",
        "status.processing": "处理中",
        "status.pending": "排队中",
        "status.error": "失败",
        "status.unknown": "未知",
        "status.not_ready": "未就绪",
        "label.id": "ID",
        "label.platform": "平台",
        "label.source": "来源",
        "label.title": "标题",
        "label.category": "分类",
        "label.category_other": "其他",
        "label.language": "语种",
        "label.status": "状态",
        "label.last_step": "最后步骤",
        "label.created": "创建时间",
        "label.pack": "剪辑包",
        "label.publish": "发布",
        "label.detail": "详情",
        "label.downloads": "下载",
        "label.json": "JSON",
        "label.task_id": "任务ID",
        "label.account": "账号",
        "label.video_type": "视频类型",
        "label.style_preset": "风格预设",
        "label.style": "风格",
        "label.note": "备注",
        "label.pipeline_tools": "流水线工具",
        "label.subtitles_mode": "字幕/翻译",
        "label.dub_mode": "配音",
        "label.source_url": "来源链接",
        "label.source_url.placeholder": "粘贴来源链接 (Douyin/XHS/TK/FB)",
        "label.platform_douyin": "抖音",
        "label.platform_tiktok": "TikTok",
        "label.platform_xhs": "小红书",
        "label.platform_fb": "Facebook",
        "label.video_type.review": "对比测评",
        "label.video_type.scenario": "场景使用",
        "label.video_type.hint": "选择业务意图",
        "label.style.fast": "短评快节奏",
        "label.style.story": "情景叙事",
        "label.style_preset.hint": "定义节奏与剪辑意图",
        "label.title.optional": "标题（可选）",
        "label.title.placeholder": "可选标题",
        "label.note.placeholder": "给运营备注",
        "label.pipeline_hint": "仅配置字幕与配音，其它工具在 Workbench 设置。",
        "label.more_tools": "更多工具请在 Tools Hub 配置。",
        "label.summary": "摘要",
        "label.lang.mm": "缅语 (MM)",
        "label.subtitles_mode.whisper_only": "Whisper only（仅 ASR 字幕）",
        "label.subtitles_mode.whisper_gemini": "Whisper + Gemini（ASR + 翻译/润色）",
        "label.dub_mode.edge": "Edge TTS",
        "label.dub_mode.lovo": "LOVO",
        "label.dub_mode.auto": "自动兜底（优先可用）",
        "label.auto_category_hint": "Auto-category: Suitcase · Language: Burmese · UI: Chinese",
        "label.submit.status.submitting": "提交中...",
        "label.submit.status.created": "已创建任务 {task_id}, 状态: {status}",
        "label.submit.status.failed": "请求失败: {error}",
        "label.submit.error.missing_link": "必须填写来源链接",
        "workbench.deliverables": "交付物",
        "workbench.deliverables.subtitle": "运营可下载交付物",
        "workbench.pack": "剪辑包",
        "workbench.scenes": "场景包",
        "workbench.video": "视频",
        "workbench.mm_subtitles": "缅文字幕",
        "workbench.mm_audio": "缅语配音",
        "workbench.scenes_section": "场景切片",
        "workbench.scenes_desc": "用于运营复用的场景切片。",
        "workbench.scenes_help": "生成场景切片会按字幕时间切分视频并打包为 Scenes.zip。点击“生成场景切片”，状态就绪后下载 Scenes.zip。无需打开或编辑 JSON。Scenes.zip 不影响 Pack.zip，两个包用途不同。",
        "workbench.scenes_action": "操作",
        "workbench.scenes_generate": "生成场景切片",
        "workbench.scenes_download": "下载 Scenes.zip",
        "workbench.publish_hub": "发布中心",
        "workbench.publish_hint": "发布已移动到独立页面。",
        "workbench.publish_open": "打开发布中心",
        "workbench.meta.task_id": "任务ID",
        "workbench.meta.platform": "平台",
        "workbench.meta.account": "账号",
        "workbench.meta.category": "分类",
        "workbench.meta.language": "语种",
        "workbench.meta.pipeline": "工具",
        "workbench.meta.status": "状态",
        "workbench.meta.created": "创建时间",
        "workbench.meta.source_url": "来源",
        "workbench.steps": "流程",
        "workbench.steps.subtitle": "运营流程视图",
        "workbench.step.parse.title": "步骤1 - 解析与下载",
        "workbench.step.parse.desc": "调用 /api/tasks/{id}/parse",
        "workbench.step.parse.run": "运行解析",
        "workbench.step.subtitles.title": "步骤2 - 字幕",
        "workbench.step.subtitles.desc": "调用 /api/tasks/{id}/subtitles 生成字幕",
        "workbench.step.subtitles.run": "生成字幕",
        "workbench.step.dub.title": "步骤3 - 缅语配音",
        "workbench.step.dub.voice": "音色",
        "workbench.step.dub.engine": "引擎",
        "workbench.step.dub.run": "生成配音",
        "workbench.step.pack.title": "步骤4 - 打包",
        "workbench.step.pack.desc": "生成本任务剪辑包",
        "workbench.step.pack.run": "生成剪辑包",
        "workbench.compare": "对比字幕",
        "workbench.compare.origin": "原始",
        "workbench.compare.mm": "缅文",
        "workbench.edit.mm": "缅文编辑 (用于配音)",
        "workbench.logs": "日志与调试",
        "workbench.logs.title": "日志",
        "workbench.logs.engineering": "工程信息",
        "workbench.origin_subtitles": "Origin Subtitles",
        "workbench.source_url_raw": "Source URL (raw)",
        "workbench.status.ready": "已就绪",
        "workbench.status.not_ready": "未就绪",
        "workbench.status.parsed": "已解析",
        "workbench.status.not_parsed": "未解析",
        "workbench.status.processing": "处理中…",
        "workbench.status.error": "失败：{error}",
        "workbench.notice.subtitles_queued": "Subtitles queued; polling status...",
        "workbench.notice.dub_queued": "Dub queued; polling status...",
        "workbench.notice.subtitles_first": "Please generate subtitles first",
        "publish.download_code": "下载码",
        "publish.gate.title": "运营门禁",
        "publish.gate.desc": "请输入 OP Access Key 以加载发布数据。",
        "publish.gate.need_key": "请输入 OP Access Key 继续。",
        "publish.gate.invalid_key": "OP Access Key 不正确。",
        "publish.gate.load_failed": "加载失败: HTTP {status}",
        "publish.tab.sop": "SOP 指引",
        "publish.tab.copy": "文案包",
        "publish.tab.deliverables": "交付物",
        "publish.tab.archive": "归档",
        "publish.sop.title": "SOP 操作指引",
        "publish.sop.desc": "v1.85 交付操作步骤。",
        "publish.sop.step1": "1) 在交付物中下载 pack.zip 或 scenes.zip。",
        "publish.sop.step2": "2) 导入手机剪辑工具（如 CapCut），核对字幕与时长。",
        "publish.sop.step3": "3) 使用文案包填写标题/话题/评论引导。",
        "publish.sop.step4": "4) v1.85 仅提供编辑交付，发布包在 2.0 提供。",
        "publish.copy.title": "文案包",
        "publish.copy.desc": "运营可编辑字段，修改不会保存。",
        "publish.copy.caption": "标题/文案",
        "publish.copy.hashtags": "话题标签",
        "publish.copy.comment": "评论引导",
        "publish.copy.link_text": "挂链文案",
        "publish.copy.publish_time": "发布时间建议",
        "publish.deliverables.title": "交付物",
        "publish.deliverables.desc": "仅显示已生成的产物。",
        "publish.deliverables.empty": "暂无交付物。",
        "publish.deliverables.bundle": "编辑包 (ZIP)",
        "publish.deliverables.qr": "扫码下载编辑包",
        "publish.deliverables.open_link": "打开链接",
        "publish.deliverables.copy_link": "复制链接",
        "publish.deliverables.short_link": "短链",
        "publish.deliverables.copy_short": "复制短链",
        "publish.archive.title": "归档",
        "publish.archive.desc": "归档确认交付，不代表已发布。",
        "publish.archive.published_at": "发布时间",
        "publish.archive.location": "归档位置",
        "publish.archive.status": "状态",
        "publish.archive.published": "已发布",
        "publish.archive.published_hint": "勾选表示已发布",
        "publish.archive.download_url": "下载链接",
        "publish.archive.open": "打开",
        "publish.archive.key": "归档 Key",
        "publish.archive.save": "保存归档",
        "publish.archive.submit": "提交归档",
        "publish.status.submitting": "提交中...",
        "publish.status.submit_failed": "提交失败: {detail}",
        "publish.status.submitted": "已提交。",
        "publish.status.submit_error": "提交错误: {error}",
        "publish.status.saving": "保存中...",
        "publish.status.save_failed": "保存失败: {detail}",
        "publish.status.saved": "已保存。",
        "publish.status.save_error": "保存错误: {error}",
        "tools.filters.search": "搜索",
        "tools.filters.category": "分类",
        "tools.filters.capabilities": "能力 (逗号)",
        "tools.filters.tags": "标签 (逗号)",
        "tools.filters.integration": "集成级别",
        "tools.filters.status": "状态",
        "tools.filters.clear": "清除筛选",
        "tools.empty": "没有匹配的工具",
        "tools.error": "加载失败",
        "tools.actions.open": "打开",
        "tools.actions.docs": "文档",
        "tools.actions.details": "详情",
        "tools.bucket.keyframe.title": "关键帧 / 确定性工程",
        "tools.bucket.keyframe.subtitle": "选镜头、切片、提关键帧",
        "tools.bucket.post.title": "后期交付（确定性）",
        "tools.bucket.post.subtitle": "转码、烧录字幕、交付封装",
        "tools.bucket.voice.title": "配音 / 音频",
        "tools.bucket.voice.subtitle": "TTS、混音、响度/降噪",
        "tools.bucket.editors.title": "剪辑器",
        "tools.bucket.editors.subtitle": "导入包、模板剪辑、移动端导出",
        "tools.bucket.face_swap.title": "换脸",
        "tools.bucket.face_swap.subtitle": "人脸替换（单/多）",
        "tools.bucket.avatar.title": "数字人",
        "tools.bucket.avatar.subtitle": "口播/驱动/素材库",
        "tools.bucket.gemini.title": "理解与生成（Gemini）",
        "tools.bucket.gemini.subtitle": "视频理解、生成、文案/脚本",
        "tools.bucket.other.title": "其他",
        "tools.bucket.other.subtitle": "未归类工具",
        "task_not_found": "任务不存在",
        "admin.tools.title": "工具管理",
        "admin.tools.save": "保存默认值",
        "auth.login.title": "运营登录",
        "auth.login.desc": "请输入 Operator 名与访问密钥（OP_ACCESS_KEY）。支持 admin/operator。",
        "auth.login.button": "登录",
    },
    "mm": {
        "lang.zh": "Chinese",
        "lang.mm": "Burmese",
        "id": "ID",
        "platform": "Platform",
        "source": "Source",
        "title": "Title",
        "category": "Category",
        "lang": "Language",
        "status": "Status",
        "created": "Created",
        "pack": "Pack",
        "publish": "Publish",
        "detail": "Detail",
        "download": "Download",
        "open": "Open",
        "json": "JSON",
        "delete": "Delete",
        "legend": "Legend",
        "new_suitcase_task": "New Task",
        "status_ready": "Ready",
        "status_processing": "Processing",
        "status_pending": "Queued",
        "status_error": "Failed",
        "status_unknown": "Unknown",
        "category_suitcase": "Suitcase",
        "category_beauty": "Beauty",
        "category_other": "Other",
        "task_count": "Task count",
        "no_tasks": "No tasks yet",
        "nav.tasks": "Tasks",
        "nav.tools": "Tools",
        "page.tasks.board.title": "Task Board",
        "page.tasks.board.subtitle": "Loaded {count} tasks",
        "page.tasks.new.title": "New Task",
        "page.tasks.new.subtitle": "Paste link → generate Smart Pack + README",
        "page.tools.hub.title": "Tools Hub",
        "page.tools.hub.subtitle": "Tool registry & entry points (SSOT)",
        "page.tools.detail.title": "Tool Detail",
        "page.workbench.title": "Workbench",
        "page.workbench.subtitle": "Task ID: {task_id}",
        "page.publish.title": "Publish Hub",
        "page.publish.subtitle": "Task ID: {task_id}",
        "action.new_task": "New Task",
        "action.refresh": "Refresh",
        "action.back_tasks": "Task Board",
        "action.back_tools": "Tools Hub",
        "action.open": "Open",
        "action.download": "Download",
        "action.copy": "Copy",
        "action.save": "Save",
        "action.submit": "Submit",
        "action.unlock": "Unlock",
        "action.create": "Create & Run",
        "action.reset": "Reset",
        "action.run": "Run",
        "status.ready": "Ready",
        "status.processing": "Processing",
        "status.pending": "Queued",
        "status.error": "Failed",
        "status.unknown": "Unknown",
        "status.not_ready": "Not ready",
        "label.id": "ID",
        "label.platform": "Platform",
        "label.source": "Source",
        "label.title": "Title",
        "label.category": "Category",
        "label.category_other": "Other",
        "label.language": "Language",
        "label.status": "Status",
        "label.last_step": "Last step",
        "label.created": "Created",
        "label.pack": "Pack",
        "label.publish": "Publish",
        "label.detail": "Detail",
        "label.downloads": "Downloads",
        "label.json": "JSON",
        "label.task_id": "Task ID",
        "label.account": "Account",
        "label.video_type": "Video type",
        "label.style_preset": "Style preset",
        "label.style": "Style",
        "label.note": "Note",
        "label.pipeline_tools": "Pipeline tools",
        "label.subtitles_mode": "Subtitles/Translate",
        "label.dub_mode": "Dub",
        "label.source_url": "Source URL",
        "label.source_url.placeholder": "Paste source URL (Douyin/XHS/TK/FB)",
        "label.platform_douyin": "Douyin",
        "label.platform_tiktok": "TikTok",
        "label.platform_xhs": "XHS",
        "label.platform_fb": "Facebook",
        "label.video_type.review": "Review",
        "label.video_type.scenario": "Scenario",
        "label.video_type.hint": "Select business intent",
        "label.style.fast": "Fast review",
        "label.style.story": "Story",
        "label.style_preset.hint": "Define tempo and edit intent",
        "label.title.optional": "Title (optional)",
        "label.title.placeholder": "Optional title",
        "label.note.placeholder": "Ops notes",
        "label.pipeline_hint": "Configure subtitles & dub only. Other tools in Workbench.",
        "label.more_tools": "More tools in Tools Hub.",
        "label.summary": "Summary",
        "label.lang.mm": "Burmese (MM)",
        "label.subtitles_mode.whisper_only": "Whisper only (ASR only)",
        "label.subtitles_mode.whisper_gemini": "Whisper + Gemini (ASR + translate)",
        "label.dub_mode.edge": "Edge TTS",
        "label.dub_mode.lovo": "LOVO",
        "label.dub_mode.auto": "Auto fallback",
        "label.auto_category_hint": "Auto-category: Suitcase · Language: Burmese · UI: Chinese",
        "label.submit.status.submitting": "Submitting...",
        "label.submit.status.created": "Task {task_id} created, status: {status}",
        "label.submit.status.failed": "Request failed: {error}",
        "label.submit.error.missing_link": "Source URL is required",
        "workbench.deliverables": "Deliverables",
        "workbench.deliverables.subtitle": "Ops deliverables for download",
        "workbench.pack": "Pack",
        "workbench.scenes": "Scenes",
        "workbench.video": "Video",
        "workbench.mm_subtitles": "Burmese subtitles",
        "workbench.mm_audio": "Burmese audio",
        "workbench.scenes_section": "Scene slices",
        "workbench.scenes_desc": "Scene slices for reuse.",
        "workbench.scenes_help": "Scenes are sliced by subtitle timestamps and packed as Scenes.zip. Click generate, then download after ready. JSON is not required. Scenes.zip does not affect Pack.zip.",
        "workbench.scenes_action": "Actions",
        "workbench.scenes_generate": "Generate scenes",
        "workbench.scenes_download": "Download Scenes.zip",
        "workbench.publish_hub": "Publish Hub",
        "workbench.publish_hint": "Publishing moved to Publish Hub.",
        "workbench.publish_open": "Open Publish Hub",
        "workbench.meta.task_id": "Task ID",
        "workbench.meta.platform": "Platform",
        "workbench.meta.account": "Account",
        "workbench.meta.category": "Category",
        "workbench.meta.language": "Language",
        "workbench.meta.pipeline": "Pipeline",
        "workbench.meta.status": "Status",
        "workbench.meta.created": "Created",
        "workbench.meta.source_url": "Source URL",
        "workbench.steps": "Pipeline",
        "workbench.steps.subtitle": "Ops workflow view",
        "workbench.step.parse.title": "Step 1 - Parse & Download",
        "workbench.step.parse.desc": "Call /api/tasks/{id}/parse",
        "workbench.step.parse.run": "Run parse",
        "workbench.step.subtitles.title": "Step 2 - Subtitles",
        "workbench.step.subtitles.desc": "Call /api/tasks/{id}/subtitles to generate",
        "workbench.step.subtitles.run": "Generate subtitles",
        "workbench.step.dub.title": "Step 3 - Dub",
        "workbench.step.dub.voice": "Voice",
        "workbench.step.dub.engine": "Engine",
        "workbench.step.dub.run": "Generate dub",
        "workbench.step.pack.title": "Step 4 - Pack",
        "workbench.step.pack.desc": "Generate pack for this task",
        "workbench.step.pack.run": "Generate pack",
        "workbench.compare": "Compare subtitles",
        "workbench.compare.origin": "Original",
        "workbench.compare.mm": "Burmese",
        "workbench.edit.mm": "Burmese edit (for dub)",
        "workbench.logs": "Logs & Debug",
        "workbench.logs.title": "Logs",
        "workbench.logs.engineering": "Engineering details",
        "workbench.origin_subtitles": "Origin Subtitles",
        "workbench.source_url_raw": "Source URL (raw)",
        "workbench.status.ready": "Ready",
        "workbench.status.not_ready": "Not ready",
        "workbench.status.parsed": "Parsed",
        "workbench.status.not_parsed": "Not parsed",
        "workbench.status.processing": "Processing...",
        "workbench.status.error": "Failed: {error}",
        "workbench.notice.subtitles_queued": "Subtitles queued; polling status...",
        "workbench.notice.dub_queued": "Dub queued; polling status...",
        "workbench.notice.subtitles_first": "Please generate subtitles first",
        "publish.download_code": "Download code",
        "publish.gate.title": "Operator gate",
        "publish.gate.desc": "Enter OP Access Key to load publish data.",
        "publish.gate.need_key": "OP Access Key is required.",
        "publish.gate.invalid_key": "OP Access Key is invalid.",
        "publish.gate.load_failed": "Load failed: HTTP {status}",
        "publish.tab.sop": "SOP",
        "publish.tab.copy": "Copy Bundle",
        "publish.tab.deliverables": "Deliverables",
        "publish.tab.archive": "Archive",
        "publish.sop.title": "SOP",
        "publish.sop.desc": "v1.85 delivery steps.",
        "publish.sop.step1": "1) Download pack.zip or scenes.zip in Deliverables.",
        "publish.sop.step2": "2) Import into mobile editor (e.g., CapCut) and verify.",
        "publish.sop.step3": "3) Use Copy Bundle for title/hashtags/comment CTA.",
        "publish.sop.step4": "4) v1.85 is edit delivery only; publish bundle comes in 2.0.",
        "publish.copy.title": "Copy Bundle",
        "publish.copy.desc": "Editable fields; edits are not saved.",
        "publish.copy.caption": "Caption",
        "publish.copy.hashtags": "Hashtags",
        "publish.copy.comment": "Comment CTA",
        "publish.copy.link_text": "Link text",
        "publish.copy.publish_time": "Publish time suggestion",
        "publish.deliverables.title": "Deliverables",
        "publish.deliverables.desc": "Show only generated artifacts.",
        "publish.deliverables.empty": "No deliverables available.",
        "publish.deliverables.bundle": "Edit Bundle (ZIP)",
        "publish.deliverables.qr": "Scan to download bundle",
        "publish.deliverables.open_link": "Open link",
        "publish.deliverables.copy_link": "Copy link",
        "publish.deliverables.short_link": "Short link",
        "publish.deliverables.copy_short": "Copy short link",
        "publish.archive.title": "Archive",
        "publish.archive.desc": "Archive confirms delivery, not published.",
        "publish.archive.published_at": "Published at",
        "publish.archive.location": "Archive location",
        "publish.archive.status": "Status",
        "publish.archive.published": "Published",
        "publish.archive.published_hint": "Check to mark published",
        "publish.archive.download_url": "Download URL",
        "publish.archive.open": "Open",
        "publish.archive.key": "Archive key",
        "publish.archive.save": "Save archive",
        "publish.archive.submit": "Submit archive",
        "publish.status.submitting": "Submitting...",
        "publish.status.submit_failed": "Submit failed: {detail}",
        "publish.status.submitted": "Submitted.",
        "publish.status.submit_error": "Submit error: {error}",
        "publish.status.saving": "Saving...",
        "publish.status.save_failed": "Save failed: {detail}",
        "publish.status.saved": "Saved.",
        "publish.status.save_error": "Save error: {error}",
        "tools.filters.search": "Search",
        "tools.filters.category": "Category",
        "tools.filters.capabilities": "Capabilities (comma)",
        "tools.filters.tags": "Tags (comma)",
        "tools.filters.integration": "Integration",
        "tools.filters.status": "Status",
        "tools.filters.clear": "Clear filters",
        "tools.empty": "No tools match filters",
        "tools.error": "Load failed",
        "tools.actions.open": "Open",
        "tools.actions.docs": "Docs",
        "tools.actions.details": "Details",
        "tools.bucket.keyframe.title": "Keyframe / Deterministic",
        "tools.bucket.keyframe.subtitle": "Shot selection, scene split, keyframes",
        "tools.bucket.post.title": "Post delivery",
        "tools.bucket.post.subtitle": "Transcode, burn subtitles, packaging",
        "tools.bucket.voice.title": "Voice / Audio",
        "tools.bucket.voice.subtitle": "TTS, mix, loudness/denoise",
        "tools.bucket.editors.title": "Editors",
        "tools.bucket.editors.subtitle": "Import pack, template edit, mobile export",
        "tools.bucket.face_swap.title": "Face swap",
        "tools.bucket.face_swap.subtitle": "Single/multi face swap",
        "tools.bucket.avatar.title": "Avatar",
        "tools.bucket.avatar.subtitle": "Talking head / assets",
        "tools.bucket.gemini.title": "Gemini",
        "tools.bucket.gemini.subtitle": "Understanding, generation, copy",
        "tools.bucket.other.title": "Other",
        "tools.bucket.other.subtitle": "Unclassified tools",
        "task_not_found": "Task not found",
        "admin.tools.title": "Tools admin",
        "admin.tools.save": "Save defaults",
        "auth.login.title": "Operator Login",
        "auth.login.desc": "Enter operator name and OP_ACCESS_KEY. Supports admin/operator.",
        "auth.login.button": "Login",
    },
}


def get_ui_locale(request: Request) -> str:
    q = request.query_params.get("ui_locale", "").strip().lower()
    if q in SUPPORTED_UI_LOCALES:
        return q
    cookie = request.cookies.get("ui_locale", "").strip().lower()
    if cookie in SUPPORTED_UI_LOCALES:
        return cookie
    if DEFAULT_UI_LOCALE in SUPPORTED_UI_LOCALES:
        return DEFAULT_UI_LOCALE
    return "zh"


def t(key: str, locale: str, **kwargs: Any) -> str:
    table = I18N_DICT.get(locale, {})
    text = table.get(key)
    if text is None:
        if STRICT_OPERATOR_LOCALE and locale == "mm":
            return f"?MISSING:{key}"
        text = I18N_DICT.get("zh", {}).get(key)
    if text is None:
        text = key
    try:
        return text.format(**kwargs)
    except Exception:
        return text


def build_i18n_payload(locale: str) -> Dict[str, object]:
    return {
        "locale": locale,
        "supported": SUPPORTED_UI_LOCALES,
        "dict": I18N_DICT,
        "strict": STRICT_OPERATOR_LOCALE,
    }
