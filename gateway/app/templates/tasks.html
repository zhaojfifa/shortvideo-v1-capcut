<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Task Board ?ShortVideo</title>
  <link rel="stylesheet" href="/static/tasks_board.css">
  <style>
    :root { color-scheme: light; }
    body {
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
      color: #0f172a;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .page { max-width: 1200px; margin: 0 auto; }
    .card {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      padding: 16px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color: #0f172a; }
    .subhead { margin: 4px 0 0; color: #6b7280; font-size: 0.95rem; }
    .bilingual { display: flex; flex-direction: column; gap: 2px; }
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      align-items: center;
      margin-top: 8px;
      font-size: 0.85rem;
      color: #475569;
    }
    .legend-title { font-weight: 600; color: #111827; }
    .legend-item { display: inline-flex; align-items: center; gap: 6px; }
    .badge-dot { width: 10px; height: 10px; border-radius: 999px; display: inline-block; }
    .dot-ready { background: #22c55e; }
    .dot-processing { background: #f59e0b; }
    .dot-pending { background: #38bdf8; }
    .dot-error { background: #ef4444; }
    .btn-primary {
      background: #2563eb;
      color: #ffffff;
      padding: 10px 14px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 700;
      font-size: 0.95rem;
      display: inline-block;
    }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      padding: 10px 14px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 700;
      font-size: 0.95rem;
      display: inline-block;
    }
    .btn-secondary:hover { background: #d1d5db; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    thead { background: #f9fafb; color: #475569; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #e5e7eb; text-align: left; vertical-align: top; }
    th { font-weight: 700; font-size: 0.9rem; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .muted { color: #6b7280; font-size: 0.95rem; }
    .badge { padding: 4px 10px; border-radius: 999px; font-size: 0.8rem; font-weight: 700; display: inline-block; }
    .badge-ready { background: #dcfce7; color: #15803d; }
    .badge-processing { background: #fef3c7; color: #b45309; }
    .badge-pending { background: #e0f2fe; color: #0369a1; }
    .badge-error { background: #fee2e2; color: #b91c1c; }
    .badge-unknown { background: #e5e7eb; color: #374151; }
    .truncate { max-width: 240px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .empty { padding: 12px 0; }
    .secondary { display: block; color: #6b7280; font-size: 0.85rem; }
    .action-stack { display: flex; flex-direction: column; gap: 6px; }
    .action-item { display: flex; flex-direction: column; gap: 2px; }
    .link-button {
      background: none;
      border: none;
      padding: 0;
      color: #2563eb;
      font-size: 0.9rem;
      text-align: left;
      cursor: pointer;
    }
    .link-button:hover { text-decoration: underline; }
    .link-button.danger { color: #dc2626; }
    @media (max-width: 768px) {
      thead { display: none; }
      table, tbody, tr, td { display: block; width: 100%; }
      tr { background: #fff; border: 1px solid #e5e7eb; border-radius: 14px; margin-bottom: 16px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
      td { border: none; padding: 8px 10px; }
      td::before {
        content: attr(data-label);
        display: block;
        font-weight: 700;
        color: #111827;
        margin-bottom: 2px;
      }
    }
  </style>
</head>
<body class="{{ 'mobile' if is_mobile else 'desktop' }}">
  <div class="page tasks-board">
    <div class="card">
      <div class="header">
        <div>
          <h1>{{ t_primary("task_board") }}</h1>
          {% if ui_show_secondary %}
            <p class="subhead secondary">{{ t_secondary("task_board") }}</p>
          {% endif %}
          <p id="task-count" class="subhead bilingual">
            <span id="task-count-primary">{{ t_primary("task_count") | replace("{count}", tasks | length) }}</span>
            {% if ui_show_secondary %}
              <span id="task-count-secondary" class="secondary">{{ t_secondary("task_count") | replace("{count}", tasks | length) }}</span>
            {% endif %}
          </p>
          <div class="legend">
            <span class="legend-title">
              {{ t_primary("legend") }}
              {% if ui_show_secondary %}
                <span class="secondary">{{ t_secondary("legend") }}</span>
              {% endif %}
            </span>
            <span class="legend-item">
              <span class="badge-dot dot-ready"></span>
              <span class="bilingual">
                <span>{{ t_primary("status_ready") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("status_ready") }}</span>
                {% endif %}
              </span>
            </span>
            <span class="legend-item">
              <span class="badge-dot dot-processing"></span>
              <span class="bilingual">
                <span>{{ t_primary("status_processing") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("status_processing") }}</span>
                {% endif %}
              </span>
            </span>
            <span class="legend-item">
              <span class="badge-dot dot-pending"></span>
              <span class="bilingual">
                <span>{{ t_primary("status_pending") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("status_pending") }}</span>
                {% endif %}
              </span>
            </span>
            <span class="legend-item">
              <span class="badge-dot dot-error"></span>
              <span class="bilingual">
                <span>{{ t_primary("status_error") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("status_error") }}</span>
                {% endif %}
              </span>
            </span>
          </div>
        </div>
        <div class="header-actions">
          <a class="btn-secondary" href="/tools/hub">Tools</a>
          <a class="btn-primary" href="/tasks/new">
            {{ t_primary("new_suitcase_task") }}
            {% if ui_show_secondary %}
              <span class="secondary">{{ t_secondary("new_suitcase_task") }}</span>
            {% endif %}
          </a>
        </div>
      </div>

      <div class="table-wrapper">
        {% set delete_label_primary = t_primary("delete") %}
        {% set delete_label = delete_label_primary if delete_label_primary != "delete" else "Delete" %}
        <table class="tasks-table">
          <thead>
            <tr>
              <th class="bilingual">
                <span>{{ t_primary("id") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("id") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t_primary("platform") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("platform") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t_primary("source") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("source") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t_primary("title") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("title") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t_primary("category") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("category") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t_primary("lang") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("lang") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t_primary("status") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("status") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t_primary("created") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("created") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t_primary("pack") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("pack") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t_primary("publish") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("publish") }}</span>
                {% endif %}
              </th>
              <th class="bilingual">
                <span>{{ t_primary("detail") }}</span>
                {% if ui_show_secondary %}
                  <span class="secondary">{{ t_secondary("detail") }}</span>
                {% endif %}
              </th>
            </tr>
          </thead>
          <tbody id="task-table-body">
            {% for t in tasks %}
              {% set status = (t.status or "unknown")|lower %}
              {% if status == "ready" %}
                {% set status_key = "status_ready" %}
              {% elif status == "processing" %}
                {% set status_key = "status_processing" %}
              {% elif status == "pending" %}
                {% set status_key = "status_pending" %}
              {% elif status == "error" %}
                {% set status_key = "status_error" %}
              {% else %}
                {% set status_key = "status_unknown" %}
              {% endif %}
              {% if status == "ready" %}
                {% set badge = "badge badge-ready" %}
              {% elif status == "processing" %}
                {% set badge = "badge badge-processing" %}
              {% elif status == "pending" %}
                {% set badge = "badge badge-pending" %}
              {% elif status == "error" %}
                {% set badge = "badge badge-error" %}
              {% else %}
                {% set badge = "badge badge-unknown" %}
              {% endif %}

              {% set cat_key = t.category_key or "-" %}
              {% if cat_key == "suitcase" %}
                {% set cat_label_primary = t_primary("category_suitcase") %}
                {% set cat_label_secondary = t_secondary("category_suitcase") %}
              {% elif cat_key == "beauty" %}
                {% set cat_label_primary = t_primary("category_beauty") %}
                {% set cat_label_secondary = t_secondary("category_beauty") %}
              {% elif cat_key == "-" %}
                {% set cat_label_primary = "-" %}
                {% set cat_label_secondary = "-" %}
              {% else %}
                {% set cat_label_primary = cat_key %}
                {% set cat_label_secondary = cat_key %}
              {% endif %}

              {% set lang_key = t.content_lang or "-" %}
              {% if lang_key == "mm" %}
                {% set lang_label = "MM" %}
              {% elif lang_key == "en" %}
                {% set lang_label = "EN" %}
              {% elif lang_key == "zh" %}
                {% set lang_label = "ZH" %}
              {% else %}
                {% set lang_label = lang_key %}
              {% endif %}

              {% set platform_key = (t.platform or "") | lower %}
              {% if platform_key == "douyin" %}
                {% set platform_label_primary = "Douyin" %}
                {% set platform_label_secondary = "Douyin" %}
              {% elif platform_key == "tk" or platform_key == "tiktok" %}
                {% set platform_label_primary = "TikTok" %}
                {% set platform_label_secondary = "TikTok" %}
              {% elif platform_key == "xhs" %}
                {% set platform_label_primary = "XHS" %}
                {% set platform_label_secondary = "XHS" %}
              {% elif platform_key == "fb" or platform_key == "facebook" %}
                {% set platform_label_primary = "Facebook" %}
                {% set platform_label_secondary = "Facebook" %}
              {% elif platform_key == "" %}
                {% set platform_label_primary = "-" %}
                {% set platform_label_secondary = "-" %}
              {% else %}
                {% set platform_label_primary = t.platform %}
                {% set platform_label_secondary = t.platform %}
              {% endif %}

              <tr>
                <td class="truncate" data-label="{{ t_primary('id') }} / {{ t_secondary('id') }}" title="{{ t.task_id }}"><a href="/tasks/{{ t.task_id }}">{{ t.task_id }}</a></td>
                <td data-label="{{ t_primary('platform') }} / {{ t_secondary('platform') }}">
                  <div class="bilingual">
                    <span>{{ platform_label_primary }}</span>
                    {% if ui_show_secondary %}
                      <span class="secondary">{{ platform_label_secondary }}</span>
                    {% endif %}
                  </div>
                </td>
                <td class="truncate" data-label="{{ t_primary('source') }} / {{ t_secondary('source') }}" title="{{ t.source_url }}">
                  {% if t.source_url %}
                    <span class="source-text">{{ t.source_url }}</span>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="truncate" data-label="{{ t_primary('title') }} / {{ t_secondary('title') }}" title="{{ t.title }}">{{ t.title or "" }}</td>
                <td data-label="{{ t_primary('category') }} / {{ t_secondary('category') }}">
                  <div class="bilingual">
                    <span>{{ cat_label_primary }}</span>
                    {% if ui_show_secondary %}
                      <span class="secondary">{{ cat_label_secondary }}</span>
                    {% endif %}
                  </div>
                </td>
                <td data-label="{{ t_primary('lang') }} / {{ t_secondary('lang') }}">{{ lang_label or "-" }}</td>
                <td data-label="{{ t_primary('status') }} / {{ t_secondary('status') }}">
                  <div class="bilingual">
                    <span class="{{ badge }}">{{ t_primary(status_key) }}</span>
                    {% if ui_show_secondary %}
                      <span class="secondary">{{ t_secondary(status_key) }}</span>
                    {% endif %}
                  </div>
                </td>
                <td data-label="{{ t_primary('created') }} / {{ t_secondary('created') }}">{{ t.created_at }}</td>
                <td data-label="{{ t_primary('pack') }} / {{ t_secondary('pack') }}">
                  {% if features.allow_pack_download %}
                    <div class="action-item">
                      <a href="/v1/tasks/{{ t.task_id }}/pack" target="_blank" rel="noopener">{{ t_primary("download") }}</a>
                      {% if ui_show_secondary %}
                        <span class="secondary">{{ t_secondary("download") }}</span>
                      {% endif %}
                    </div>
                  {% else %}
                    ?
                  {% endif %}
                </td>
                <td data-label="{{ t_primary('publish') }} / {{ t_secondary('publish') }}">
                  <div class="action-item">
                    <a href="/tasks/{{ t.task_id }}/publish">{{ t_primary("publish") }}</a>
                    {% if ui_show_secondary %}
                      <span class="secondary">{{ t_secondary("publish") }}</span>
                    {% endif %}
                  </div>
                </td>
                <td data-label="{{ t_primary('detail') }} / {{ t_secondary('detail') }}">
                  <div class="action-stack">
                                        <div class="action-item">
                      <a href="/tasks/{{ t.task_id }}/publish">Publish Hub</a>
                      {% if ui_show_secondary %}
                        <span class="secondary">Publish Hub</span>
                      {% endif %}
                    </div>
<div class="action-item">
                      <a href="/tasks/{{ t.task_id }}">{{ t_primary("open") }}</a>
                      {% if ui_show_secondary %}
                        <span class="secondary">{{ t_secondary("open") }}</span>
                      {% endif %}
                    </div>
                    {% set pipeline = t.pipeline_config or {} %}
                    {% set subtitles_mode = pipeline.get("subtitles_mode", "whisper+gemini") %}
                    {% set dub_mode = pipeline.get("dub_mode", "auto-fallback") %}
                    <div class="action-item">
                      <span class="muted">Subtitles: {{ subtitles_mode }}</span>
                    </div>
                    <div class="action-item">
                      <span class="muted">Dub: {{ dub_mode }}</span>
                    </div>
                    <div class="action-item">
                      <button type="button"
                              class="link-button danger"
                              data-action="delete"
                              data-task-id="{{ t.task_id }}">
                        {{ delete_label }}
                      </button>
                    </div>
                    <div class="action-item">
                      <a href="/api/tasks/{{ t.task_id }}" target="_blank" rel="noopener">{{ t_primary("json") }}</a>
                      {% if ui_show_secondary %}
                        <span class="secondary">{{ t_secondary("json") }}</span>
                      {% endif %}
                    </div>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    window.__FEATURES__ = {{ features | tojson | safe }};
    const initialTasks = {{ tasks | tojson | safe }};
    const allowPackDownload = {{ "true" if features.allow_pack_download else "false" }};
    const tableBody = document.getElementById("task-table-body");
    const countPrimaryEl = document.getElementById("task-count-primary");
    const countSecondaryEl = document.getElementById("task-count-secondary");
    const showSecondary = {{ "true" if ui_show_secondary else "false" }};
    const LABELS = {
      id: "{{ t_primary('id') }} / {{ t_secondary('id') }}",
      platform: "{{ t_primary('platform') }} / {{ t_secondary('platform') }}",
      source: "{{ t_primary('source') }} / {{ t_secondary('source') }}",
      title: "{{ t_primary('title') }} / {{ t_secondary('title') }}",
      category: "{{ t_primary('category') }} / {{ t_secondary('category') }}",
      lang: "{{ t_primary('lang') }} / {{ t_secondary('lang') }}",
      status: "{{ t_primary('status') }} / {{ t_secondary('status') }}",
      created: "{{ t_primary('created') }} / {{ t_secondary('created') }}",
      pack: "{{ t_primary('pack') }} / {{ t_secondary('pack') }}",
      detail: "{{ t_primary('detail') }} / {{ t_secondary('detail') }}",
    };
    const STATUS_LABELS = {
      ready: { primary: "{{ t_primary('status_ready') }}", secondary: "{{ t_secondary('status_ready') }}" },
      processing: { primary: "{{ t_primary('status_processing') }}", secondary: "{{ t_secondary('status_processing') }}" },
      pending: { primary: "{{ t_primary('status_pending') }}", secondary: "{{ t_secondary('status_pending') }}" },
      error: { primary: "{{ t_primary('status_error') }}", secondary: "{{ t_secondary('status_error') }}" },
      unknown: { primary: "{{ t_primary('status_unknown') }}", secondary: "{{ t_secondary('status_unknown') }}" },
    };
    const CATEGORY_LABELS = {
      suitcase: { primary: "{{ t_primary('category_suitcase') }}", secondary: "{{ t_secondary('category_suitcase') }}" },
      beauty: { primary: "{{ t_primary('category_beauty') }}", secondary: "{{ t_secondary('category_beauty') }}" },
      other: { primary: "{{ t_primary('category_other') }}", secondary: "{{ t_secondary('category_other') }}" },
    };
    const PLATFORM_LABELS = {
      douyin: { primary: "抖音", secondary: "ဒေါ်ယင်" },
      tk: { primary: "TikTok", secondary: "TikTok" },
      tiktok: { primary: "TikTok", secondary: "TikTok" },
      xhs: { primary: "小红书", secondary: "小红书" },
      fb: { primary: "Facebook", secondary: "Facebook" },
      facebook: { primary: "Facebook", secondary: "Facebook" },
    };
    const COUNT_LABELS = {
      primary: "{{ t_primary('task_count') }}",
      secondary: "{{ t_secondary('task_count') }}",
    };
    const DELETE_LABEL = "{{ delete_label }}";

    function statusBadgeClass(status) {
      if (status === "ready") return "badge badge-ready";
      if (status === "processing") return "badge badge-processing";
      if (status === "pending") return "badge badge-pending";
      if (status === "error") return "badge badge-error";
      return "badge badge-unknown";
    }

    function categoryLabel(key) {
      if (!key) return { primary: "-", secondary: "-" };
      const lower = String(key).toLowerCase();
      if (CATEGORY_LABELS[lower]) return CATEGORY_LABELS[lower];
      return { primary: key, secondary: key };
    }

    function platformLabel(key) {
      if (!key) return { primary: "-", secondary: "-" };
      const lower = String(key).toLowerCase();
      if (PLATFORM_LABELS[lower]) return PLATFORM_LABELS[lower];
      return { primary: key, secondary: key };
    }

    function statusLabel(status) {
      if (!status) return STATUS_LABELS.unknown;
      const lower = String(status).toLowerCase();
      return STATUS_LABELS[lower] || STATUS_LABELS.unknown;
    }

    function langLabel(code) {
      if (!code) return "-";
      const lower = String(code).toLowerCase();
      if (lower === "mm") return "MM";
      if (lower === "en") return "EN";
      if (lower === "zh") return "ZH";
      return code;
    }

    function truncate(text, limit = 240) {
      if (!text) return "";
      return text.length > limit ? `${text.slice(0, limit - 1)}…` : text;
    }

    function extractFirstHttpUrl(text) {
      if (!text) return null;
      const s = String(text);
      const m = s.match(/https?:\/\/[^\s]+/i);
      return m ? m[0] : null;
    }

    function enhanceSourceLinks() {
      document.querySelectorAll("td .source-text").forEach((el) => {
        const raw = el.textContent || "";
        const url = extractFirstHttpUrl(raw);
        if (!url) return;
        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = el.textContent;
        el.replaceWith(a);
      });
    }

    function renderTasks(tasks) {
      tableBody.innerHTML = "";

      if (!tasks.length) {
        const emptyRow = document.createElement("tr");
        const emptyCell = document.createElement("td");
        emptyCell.colSpan = 10;
        emptyCell.className = "empty muted";
        emptyCell.innerHTML = `
          <div class="bilingual">
            <span>{{ t_primary("no_tasks") }}</span>
            ${showSecondary ? `<span class="secondary">{{ t_secondary("no_tasks") }}</span>` : ""}
          </div>
        `;
        emptyRow.appendChild(emptyCell);
        tableBody.appendChild(emptyRow);
      } else {
        for (const t of tasks) {
          const status = t.status || "unknown";
          const catLabel = categoryLabel(t.category_key);
          const statusLabels = statusLabel(status);
          const lang = langLabel(t.content_lang);
          const platform = platformLabel(t.platform);
          const srcRaw = t.source_url || "";
          const srcUrl = extractFirstHttpUrl(srcRaw);
          const row = document.createElement("tr");
          const pipeline = t.pipeline_config || {};
          const subtitlesMode = pipeline.subtitles_mode || "whisper+gemini";
          const dubMode = pipeline.dub_mode || "auto-fallback";
          row.innerHTML = `
            <td class="truncate" data-label="${LABELS.id}" title="${t.task_id || ""}"><a href="/tasks/${t.task_id}">${truncate(t.task_id, 16)}</a></td>
            <td data-label="${LABELS.platform}">
              <div class="bilingual">
                <span>${platform.primary}</span>
                ${showSecondary ? `<span class="secondary">${platform.secondary}</span>` : ""}
              </div>
            </td>
            <td class="truncate" data-label="${LABELS.source}" title="${srcRaw}">
              ${srcRaw
                ? (srcUrl
                  ? `<a href="${srcUrl}" target="_blank" rel="noopener">${truncate(srcRaw, 48)}</a>`
                  : `<span class="muted">${truncate(srcRaw, 48)}</span>`)
                : "-"}
            </td>
            <td class="truncate" data-label="${LABELS.title}" title="${t.title || ""}">${t.title || ""}</td>
            <td data-label="${LABELS.category}">
              <div class="bilingual">
                <span>${catLabel.primary}</span>
                ${showSecondary ? `<span class="secondary">${catLabel.secondary}</span>` : ""}
              </div>
            </td>
            <td data-label="${LABELS.lang}">${lang}</td>
            <td data-label="${LABELS.status}">
              <div class="bilingual">
                <span class="${statusBadgeClass(status)}">${statusLabels.primary}</span>
                ${showSecondary ? `<span class="secondary">${statusLabels.secondary}</span>` : ""}
              </div>
            </td>
            <td data-label="${LABELS.created}">${t.created_at || ""}</td>
            <td data-label="${LABELS.pack}">${
              (allowPackDownload)
                ? `<div class="action-item">
                    <a href="/v1/tasks/${t.task_id}/pack" target="_blank" rel="noopener">{{ t_primary("download") }}</a>
                    ${showSecondary ? `<span class="secondary">{{ t_secondary("download") }}</span>` : ""}
                  </div>`
                : "–"
            }</td>
            <td data-label="${LABELS.detail}">
              <div class="action-stack">
                <div class="action-item">
                  <a href="/tasks/${t.task_id}">{{ t_primary("open") }}</a>
                  ${showSecondary ? `<span class="secondary">{{ t_secondary("open") }}</span>` : ""}
                </div>
                <div class="action-item">
                  <span class="muted">Subtitles: ${subtitlesMode}</span>
                </div>
                <div class="action-item">
                  <span class="muted">Dub: ${dubMode}</span>
                </div>
                <div class="action-item">
                  <button type="button"
                          class="link-button danger"
                          data-action="delete"
                          data-task-id="${t.task_id}">
                    ${DELETE_LABEL}
                  </button>
                </div>
                <div class="action-item">
                  <a href="/api/tasks/${t.task_id}" target="_blank" rel="noopener">{{ t_primary("json") }}</a>
                  ${showSecondary ? `<span class="secondary">{{ t_secondary("json") }}</span>` : ""}
                </div>
              </div>
            </td>
          `;
          tableBody.appendChild(row);
        }
      }

      enhanceSourceLinks();
      const count = tasks.length;
      if (countPrimaryEl) {
        countPrimaryEl.textContent = COUNT_LABELS.primary.replace("{count}", count);
      }
      if (countSecondaryEl) {
        countSecondaryEl.textContent = COUNT_LABELS.secondary.replace("{count}", count);
      }
    }

    let tasksPollTimer = null;
    let tasksInFlight = false;
    const TASKS_POLL_MS = 10000;
    let currentPollMs = TASKS_POLL_MS;

    function stopTasksPolling() {
      if (!tasksPollTimer) return;
      clearInterval(tasksPollTimer);
      tasksPollTimer = null;
    }

    function startTasksPolling() {
      if (tasksPollTimer) return;
      fetchTasksOnce();
      tasksPollTimer = setInterval(fetchTasksOnce, currentPollMs);
    }

    function restartTasksPolling() {
      if (!tasksPollTimer) return;
      stopTasksPolling();
      tasksPollTimer = setInterval(fetchTasksOnce, currentPollMs);
    }

    async function fetchTasksOnce() {
      if (document.visibilityState !== "visible") return;
      if (tasksInFlight) return;

      tasksInFlight = true;
      if (countPrimaryEl) {
        countPrimaryEl.textContent = "Loading tasks…";
      }
      if (countSecondaryEl) {
        countSecondaryEl.textContent = "";
      }
      try {
        const url = `/api/tasks?limit=50&ts=${Date.now()}`;
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const tasks = Array.isArray(data) ? data : (data.items || []);
        renderTasks(tasks);
        if (currentPollMs != TASKS_POLL_MS) {
          currentPollMs = TASKS_POLL_MS;
          restartTasksPolling();
        }
      } catch (err) {
        console.error(err);
        if (countPrimaryEl) {
          countPrimaryEl.textContent = `Failed to load tasks: ${err.message}`;
        }
        if (countSecondaryEl) {
          countSecondaryEl.textContent = "";
        }
        const nextMs = Math.min(currentPollMs * 2, 60000);
        if (nextMs != currentPollMs) {
          currentPollMs = nextMs;
          restartTasksPolling();
        }
      } finally {
        tasksInFlight = false;
      }
    }

    renderTasks(initialTasks || []);

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") {
        startTasksPolling();
      } else {
        stopTasksPolling();
      }
    });

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", startTasksPolling, { once: true });
    } else {
      startTasksPolling();
    }

    async function handleDeleteClick(event) {
      const button = event.target.closest("[data-action='delete']");
      if (!button) return;
      if (button.getAttribute("data-action") !== "delete") return;
      event.preventDefault();
      const taskId = button.dataset.taskId;
      if (!taskId) return;
      const confirmed = window.confirm("Delete this task?");
      if (!confirmed) return;
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = "Deleting...";
      try {
        const res = await fetch(`/api/tasks/${encodeURIComponent(taskId)}?delete_assets=false`, {
          method: "DELETE",
        });
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        const row = button.closest("tr");
        if (row) {
          row.remove();
        }
        if (typeof fetchTasksOnce === "function") {
          fetchTasksOnce();
        }
      } catch (err) {
        console.error(err);
        window.alert(`Delete failed: ${err.message}`);
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    if (tableBody) {
      tableBody.addEventListener("click", handleDeleteClick);
    }

    // Polling is driven by the visibility handler above.
  </script>
</body>
</html>








