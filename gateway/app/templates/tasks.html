<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Task Board · ShortVideo</title>
  <style>
    :root { color-scheme: light; }
    body {
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
      color: #0f172a;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .page { max-width: 1200px; margin: 0 auto; }
    .card {
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      padding: 16px;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    h1 { margin: 0; font-size: 1.5rem; font-weight: 700; color: #0f172a; }
    .subhead { margin: 4px 0 0; color: #6b7280; font-size: 0.95rem; }
    .btn-primary {
      background: #2563eb;
      color: #ffffff;
      padding: 10px 14px;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 700;
      font-size: 0.95rem;
      display: inline-block;
    }
    .btn-primary:hover { background: #1d4ed8; }
    .table-wrapper { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    thead { background: #f9fafb; color: #475569; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #e5e7eb; text-align: left; }
    th { font-weight: 700; font-size: 0.9rem; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .muted { color: #6b7280; font-size: 0.95rem; }
    .badge { padding: 4px 10px; border-radius: 999px; font-size: 0.8rem; font-weight: 700; display: inline-block; }
    .badge-ready { background: #dcfce7; color: #15803d; }
    .badge-processing { background: #fef3c7; color: #b45309; }
    .badge-error { background: #fee2e2; color: #b91c1c; }
    .badge-unknown { background: #e5e7eb; color: #374151; }
    .truncate { max-width: 240px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .empty { padding: 12px 0; }
    .secondary { display: block; color: #6b7280; font-size: 0.85rem; }
    @media (max-width: 768px) {
      thead { display: none; }
      table, tbody, tr, td { display: block; width: 100%; }
      tr { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 12px; padding: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
      td { border: none; padding: 6px 8px; }
      td::before {
        content: attr(data-label);
        display: block;
        font-weight: 700;
        color: #111827;
        margin-bottom: 2px;
      }
    }
  </style>
</head>
<body class="{{ 'mobile' if is_mobile else 'desktop' }}">
  <div class="page">
    <div class="card">
      <div class="header">
        <div>
          <h1>{{ t_primary("task_board") }}</h1>
          {% if ui_show_secondary %}
            <p class="subhead secondary">{{ t_secondary("task_board") }}</p>
          {% endif %}
          <p id="task-count" class="subhead">Loaded {{ tasks | length }} task{{ "s" if (tasks | length) != 1 else "" }}.</p>
        </div>
        <a class="btn-primary" href="/tasks/new">
          {{ t_primary("new_suitcase_task") }}
          {% if ui_show_secondary %}
            <span class="secondary">{{ t_secondary("new_suitcase_task") }}</span>
          {% endif %}
        </a>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>{{ t_primary("id") }}</th>
              <th>{{ t_primary("platform") }}</th>
              <th>{{ t_primary("source") }}</th>
              <th>{{ t_primary("title") }}</th>
              <th>{{ t_primary("category") }}</th>
              <th>{{ t_primary("lang") }}</th>
              <th>{{ t_primary("status") }}</th>
              <th>{{ t_primary("created") }}</th>
              <th>{{ t_primary("pack") }}</th>
              <th>{{ t_primary("detail") }}</th>
            </tr>
          </thead>
          <tbody id="task-table-body">
            {% for t in tasks %}
              {% set status = t.status or "unknown" %}
              {% if status == "ready" %}
                {% set badge = "badge badge-ready" %}
              {% elif status == "processing" %}
                {% set badge = "badge badge-processing" %}
              {% elif status == "error" %}
                {% set badge = "badge badge-error" %}
              {% else %}
                {% set badge = "badge badge-unknown" %}
              {% endif %}

              {% set cat_key = t.category_key or "-" %}
              {% if cat_key == "suitcase" %}
                {% set cat_label = "Suitcase" %}
              {% elif cat_key == "beauty" %}
                {% set cat_label = "Beauty" %}
              {% else %}
                {% set cat_label = cat_key %}
              {% endif %}

              {% set lang_key = t.content_lang or "-" %}
              {% if lang_key == "mm" %}
                {% set lang_label = "MM" %}
              {% elif lang_key == "en" %}
                {% set lang_label = "EN" %}
              {% elif lang_key == "zh" %}
                {% set lang_label = "ZH" %}
              {% else %}
                {% set lang_label = lang_key %}
              {% endif %}

              <tr>
                <td class="truncate" data-label="{{ t_primary('id') }} / {{ t_secondary('id') }}" title="{{ t.task_id }}"><a href="/tasks/{{ t.task_id }}">{{ t.task_id }}</a></td>
                <td data-label="{{ t_primary('platform') }} / {{ t_secondary('platform') }}">{{ t.platform or "" }}</td>
                <td class="truncate" data-label="{{ t_primary('source') }} / {{ t_secondary('source') }}" title="{{ t.source_url }}">
                  {% if t.source_url %}
                    <span class="source-text">{{ t.source_url }}</span>
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td class="truncate" data-label="{{ t_primary('title') }} / {{ t_secondary('title') }}" title="{{ t.title }}">{{ t.title or "" }}</td>
                <td data-label="{{ t_primary('category') }} / {{ t_secondary('category') }}">{{ cat_label or "-" }}</td>
                <td data-label="{{ t_primary('lang') }} / {{ t_secondary('lang') }}">{{ lang_label or "-" }}</td>
                <td data-label="{{ t_primary('status') }} / {{ t_secondary('status') }}"><span class="{{ badge }}">{{ status }}</span></td>
                <td data-label="{{ t_primary('created') }} / {{ t_secondary('created') }}">{{ t.created_at }}</td>
                <td data-label="{{ t_primary('pack') }} / {{ t_secondary('pack') }}">
                  {% if t.pack_path %}
                    <a href="/files/{{ t.pack_path }}" target="_blank" rel="noopener">Download</a>
                  {% else %}
                    –
                  {% endif %}
                </td>
                <td data-label="{{ t_primary('detail') }} / {{ t_secondary('detail') }}"><a href="/tasks/{{ t.task_id }}">Open</a> · <a href="/api/tasks/{{ t.task_id }}" target="_blank" rel="noopener">JSON</a></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    window.__FEATURES__ = {{ features | tojson | safe }};
    const initialTasks = {{ tasks | tojson | safe }};
    const tableBody = document.getElementById("task-table-body");
    const countEl = document.getElementById("task-count");
    const LABELS = {
      id: "{{ t_primary('id') }} / {{ t_secondary('id') }}",
      platform: "{{ t_primary('platform') }} / {{ t_secondary('platform') }}",
      source: "{{ t_primary('source') }} / {{ t_secondary('source') }}",
      title: "{{ t_primary('title') }} / {{ t_secondary('title') }}",
      category: "{{ t_primary('category') }} / {{ t_secondary('category') }}",
      lang: "{{ t_primary('lang') }} / {{ t_secondary('lang') }}",
      status: "{{ t_primary('status') }} / {{ t_secondary('status') }}",
      created: "{{ t_primary('created') }} / {{ t_secondary('created') }}",
      pack: "{{ t_primary('pack') }} / {{ t_secondary('pack') }}",
      detail: "{{ t_primary('detail') }} / {{ t_secondary('detail') }}",
    };

    function statusBadgeClass(status) {
      if (status === "ready") return "badge badge-ready";
      if (status === "processing") return "badge badge-processing";
      if (status === "error") return "badge badge-error";
      return "badge badge-unknown";
    }

    function categoryLabel(key) {
      if (!key) return "-";
      if (key === "suitcase") return "Suitcase";
      if (key === "beauty") return "Beauty";
      return key;
    }

    function langLabel(code) {
      if (!code) return "-";
      const lower = String(code).toLowerCase();
      if (lower === "mm") return "MM";
      if (lower === "en") return "EN";
      if (lower === "zh") return "ZH";
      return code;
    }

    function truncate(text, limit = 240) {
      if (!text) return "";
      return text.length > limit ? `${text.slice(0, limit - 1)}…` : text;
    }

    function extractFirstHttpUrl(text) {
      if (!text) return null;
      const s = String(text);
      const m = s.match(/https?:\/\/[^\s]+/i);
      return m ? m[0] : null;
    }

    function enhanceSourceLinks() {
      document.querySelectorAll("td .source-text").forEach((el) => {
        const raw = el.textContent || "";
        const url = extractFirstHttpUrl(raw);
        if (!url) return;
        const a = document.createElement("a");
        a.href = url;
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = el.textContent;
        el.replaceWith(a);
      });
    }

    function renderTasks(tasks) {
      tableBody.innerHTML = "";

      if (!tasks.length) {
        const emptyRow = document.createElement("tr");
        const emptyCell = document.createElement("td");
        emptyCell.colSpan = 10;
        emptyCell.className = "empty muted";
        emptyCell.textContent = "No tasks yet.";
        emptyRow.appendChild(emptyCell);
        tableBody.appendChild(emptyRow);
      } else {
        for (const t of tasks) {
          const status = t.status || "unknown";
          const catLabel = categoryLabel(t.category_key);
          const lang = langLabel(t.content_lang);
          const srcRaw = t.source_url || "";
          const srcUrl = extractFirstHttpUrl(srcRaw);
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="truncate" data-label="${LABELS.id}" title="${t.task_id || ""}"><a href="/tasks/${t.task_id}">${truncate(t.task_id, 16)}</a></td>
            <td data-label="${LABELS.platform}">${t.platform || ""}</td>
            <td class="truncate" data-label="${LABELS.source}" title="${srcRaw}">
              ${srcRaw
                ? (srcUrl
                  ? `<a href="${srcUrl}" target="_blank" rel="noopener">${truncate(srcRaw, 48)}</a>`
                  : `<span class="muted">${truncate(srcRaw, 48)}</span>`)
                : "-"}
            </td>
            <td class="truncate" data-label="${LABELS.title}" title="${t.title || ""}">${t.title || ""}</td>
            <td data-label="${LABELS.category}">${catLabel}</td>
            <td data-label="${LABELS.lang}">${lang}</td>
            <td data-label="${LABELS.status}"><span class="${statusBadgeClass(status)}">${status}</span></td>
            <td data-label="${LABELS.created}">${t.created_at || ""}</td>
            <td data-label="${LABELS.pack}">${t.pack_path ? `<a href="/files/${t.pack_path}" target="_blank" rel="noopener">Download</a>` : "–"}</td>
            <td data-label="${LABELS.detail}"><a href="/tasks/${t.task_id}">Open</a> · <a href="/api/tasks/${t.task_id}" target="_blank" rel="noopener">JSON</a></td>
          `;
          tableBody.appendChild(row);
        }
      }

      enhanceSourceLinks();
      const count = tasks.length;
      countEl.textContent = `Loaded ${count} task${count === 1 ? "" : "s"}.`;
    }

    function hasInFlight(tasks) {
      return tasks.some((t) => {
        const s = String(t.status || "").toLowerCase();
        return s === "pending" || s === "processing";
      });
    }

    let pollTimer = null;

    async function refreshTasks() {
      countEl.textContent = "Loading tasks…";
      try {
        const url = `/api/tasks?limit=50&ts=${Date.now()}`;
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const tasks = Array.isArray(data) ? data : (data.items || []);
        renderTasks(tasks);

        if (hasInFlight(tasks)) {
          if (!pollTimer) {
            pollTimer = setInterval(refreshTasks, 5000);
          }
        } else if (pollTimer) {
          clearInterval(pollTimer);
          pollTimer = null;
        }
      } catch (err) {
        console.error(err);
        countEl.textContent = `Failed to load tasks: ${err.message}`;
      }
    }

    renderTasks(initialTasks || []);

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", refreshTasks, { once: true });
    } else {
      refreshTasks();
    }

    window.addEventListener("focus", () => refreshTasks());
  </script>
</body>
</html>
