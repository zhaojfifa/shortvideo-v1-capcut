<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>新建任务 - ShortVideo</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;600;700&display=swap" />
  <link rel="stylesheet" href="/static/i18n.css" />
  <style>
    :root { color-scheme: light; }
    body {
      margin: 0;
      padding: 16px;
      background: #f3f4f6;
      color: #111827;
    }
    .page { max-width: 720px; margin: 0 auto; }
    header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    h1 { margin: 0; font-size: 1.5rem; font-weight: 700; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      border: 1px solid #e5e7eb;
    }
    .field { margin-bottom: 12px; }
    label { display: block; font-weight: 600; margin-bottom: 4px; }
    input, select, textarea {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 10px;
      font-size: 1rem;
      background: #fff;
    }
    textarea { min-height: 80px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .row .field { flex: 1 1 220px; }
    .radio-group { display: flex; gap: 12px; flex-wrap: wrap; }
    .radio { display: flex; gap: 6px; align-items: center; }
    .btn-primary {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      border: none;
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-secondary:hover { background: #d1d5db; }
    .tools-actions { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0; }
    .tools-buckets { display: grid; gap: 12px; }
    .tools-bucket { border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px; background: #f9fafb; }
    .tools-bucket h4 { margin: 0 0 4px; font-size: 1rem; }
    .tools-bucket .subtitle { color: #6b7280; font-size: 0.85rem; margin-bottom: 6px; }
    .tool-item { display: flex; gap: 8px; align-items: flex-start; margin-bottom: 6px; }
    .tool-item input { width: auto; margin-top: 3px; }
    .tool-item .tool-meta { font-size: 0.85rem; color: #6b7280; }
    .muted { color: #6b7280; font-size: 0.9rem; }
    .summary {
      border: 1px dashed #d1d5db;
      border-radius: 10px;
      padding: 10px 12px;
      background: #f9fafb;
      margin: 12px 0;
    }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 8px; }
    .summary-item strong { display: block; font-size: 0.85rem; color: #111827; }
    pre { background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #e5e7eb; }
    .error { color: #b91c1c; }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>{{ t_primary("new_suitcase_task") }}</h1>
      {% if ui_show_secondary %}
        <div class="muted t-secondary">{{ t_secondary("new_suitcase_task") }}</div>
      {% endif %}
      <a href="/tasks">返回任务看板 <span class="muted t-secondary">/ တာဝန်စာရင်းသို့ ပြန်ရန်</span></a>
    </header>

    <main class="card">
      <form id="task-form">
        <div class="field">
          <label for="source_url">来源链接 <span class="muted t-secondary">/ အရင်းအမြစ် URL</span> *</label>
          <input id="source_url" name="source_url" type="text" autocomplete="off" required placeholder="粘贴来源链接 (Douyin/XHS/TK/FB) / အရင်းအမြစ် URL ကို ထည့်ပါ" />
        </div>

        <div class="row">
          <div class="field">
            <label for="platform">平台 <span class="muted t-secondary">/ ပလက်ဖောင်း</span></label>
            <select id="platform" name="platform">
              <option value="douyin" selected>抖音 / ဒေါ်ယင်</option>
              <option value="xhs">小红书 / 小红书</option>
              <option value="tiktok">TikTok / TikTok</option>
              <option value="fb">Facebook / Facebook</option>
            </select>
          </div>
          <div class="field">
            <label for="account_id">账号 <span class="muted t-secondary">/ အကောင့်</span></label>
            <select id="account_id" name="account_id">
              <option value="suitcase_mm_1">Suitcase MM #1</option>
            </select>
            <input type="hidden" id="account_name" name="account_name" value="Suitcase MM #1" />
          </div>
        </div>

        <div class="field">
          <label>视频类型 <span class="muted t-secondary">/ ဗီဒီယိုအမျိုးအစား</span></label>
          <div class="muted t-secondary">选择业务意图 / အသုံးပြုရည်ရွယ်ချက်ကို ရွေးပါ</div>
          <div class="radio-group" style="margin-top:6px;">
            <label class="radio"><input type="radio" name="video_type" value="review" checked /> 对比测评 / နှိုင်းယှဉ်သုံးသပ်</label>
            <label class="radio"><input type="radio" name="video_type" value="scenario" /> 场景使用 / အခြေအနေအသုံးပြု</label>
          </div>
        </div>

        <div class="field">
          <label>风格预设 <span class="muted t-secondary">/ စတိုင်</span></label>
          <div class="muted t-secondary">定义节奏与剪辑意图 / အမြန်နှုန်းနှင့်剪辑ရည်ရွယ်ချက်</div>
          <div class="radio-group" style="margin-top:6px;">
            <label class="radio"><input type="radio" name="style_preset" value="review_brief" checked /> 短评快节奏 / အတိုပြန်လည်သုံးသပ်</label>
            <label class="radio"><input type="radio" name="style_preset" value="scenario_story" /> 情景叙事 / ဇာတ်လမ်းပုံစံ</label>
          </div>
        </div>

        <div class="field">
          <label for="title">标题（可选） <span class="muted t-secondary">/ ခေါင်းစဉ် (ရွေးချယ်)</span></label>
          <input id="title" name="title" type="text" placeholder="可选标题 / ခေါင်းစဉ် (ရွေးချယ်)" />
        </div>

        <div class="field">
          <label for="note">备注 / 运营提示 <span class="muted t-secondary">/ မှတ်ချက်</span></label>
          <textarea id="note" name="note" placeholder="给运营备注 / အော်ပရေးရှင်းမှတ်ချက်"></textarea>
        </div>

        <div class="field" id="tools-section">
          <label>Tools / ??</label>
          <div class="muted">Default: all tools selected.</div>
          <div class="tools-actions">
            <button type="button" class="btn-secondary" id="tools-select-all">Select All</button>
            <button type="button" class="btn-secondary" id="tools-select-recommended">Select Recommended</button>
            <button type="button" class="btn-secondary" id="tools-clear">Clear</button>
          </div>
          <div id="tools-buckets" class="tools-buckets"></div>
        </div>

        <div class="summary" id="summary-block">
          <div class="summary-grid">
            <div class="summary-item"><strong>平台 <span class="muted t-secondary">/ ပလက်ဖောင်း</span></strong><span id="summary-platform">-</span></div>
            <div class="summary-item"><strong>账号 <span class="muted t-secondary">/ အကောင့်</span></strong><span id="summary-account">-</span></div>
            <div class="summary-item"><strong>视频类型 <span class="muted t-secondary">/ ဗီဒီယိုအမျိုးအစား</span></strong><span id="summary-video">-</span></div>
            <div class="summary-item"><strong>风格 <span class="muted t-secondary">/ စတိုင်</span></strong><span id="summary-style">-</span></div>
            <div class="summary-item"><strong>语种 <span class="muted t-secondary">/ ဘာသာ</span></strong><span id="summary-lang">缅语 (MM) / မြန်မာ (MM)</span></div>
          </div>
        </div>

        <button class="btn-primary" type="submit">创建并运行 <span class="muted t-secondary">/ တာဝန်ဖန်တီးပြီး စတင်</span></button>
        <div class="muted t-secondary" style="margin-top: 6px;">Auto-category: Suitcase · Language: Burmese · UI: Chinese <span class="muted t-secondary">/ Auto category · Language · UI</span></div>
      </form>

      <div style="margin-top: 12px;">
        <pre id="create-result"></pre>
      </div>
    </main>
  </div>

  <script>
    window.__FEATURES__ = {{ features | tojson | safe }};
    const form = document.getElementById("task-form");
    const resultEl = document.getElementById("create-result");

    const toolsState = { items: [], selected: new Set() };
    const BUCKETS = [
      { key: "keyframe_det", title: "??? / ?????", subtitle: "???????????", ids: ["local:ffprobe_inspect", "local:ffmpeg_scene_split", "local:ffmpeg_keyframe_extract"] },
      { key: "post_det", title: "?????????", subtitle: "????????????", ids: ["local:ffmpeg_transcode", "local:ffmpeg_burn_subtitles"] },
      { key: "voice_audio", title: "?? / ??", subtitle: "TTS??????/??", ids: ["local:ffmpeg_audio_mix", "tts:edge_tts", "tts:lovo"] },
      { key: "editors", title: "???", subtitle: "??????????????", ids: ["editor:capcut", "editor:youcut", "editor:vn"] },
      { key: "face_swap", title: "??", subtitle: "??????/??", ids: ["vendor:akool_face_swap"] },
      { key: "avatar", title: "???", subtitle: "??/??/???", ids: ["vendor:kling_motion", "vendor:heygen_avatar"] },
      { key: "gemini", title: "??????Gemini?", subtitle: "??????????/??", ids: ["google:gemini_video_understanding", "google:veo", "google:gemini_copywriter", "asr:whisper"] },
    ];

    function toolName(tool) {
      const name = tool.name || {};
      return name.zh || name.en || name.mm || tool.tool_id;
    }

    function renderTools() {
      const container = document.getElementById("tools-buckets");
      if (!container) return;
      container.innerHTML = "";
      const toolMap = new Map(toolsState.items.map((t) => [t.tool_id, t]));
      const seen = new Set();

      const addBucket = (title, subtitle, items) => {
        if (!items.length) return;
        const bucket = document.createElement("div");
        bucket.className = "tools-bucket";
        bucket.innerHTML = `<h4>${title}</h4><div class="subtitle">${subtitle}</div>`;
        items.forEach((tool) => {
          const row = document.createElement("label");
          row.className = "tool-item";
          const checked = toolsState.selected.has(tool.tool_id) ? "checked" : "";
          row.innerHTML = `
            <input type="checkbox" data-tool-id="${tool.tool_id}" ${checked} />
            <div>
              <div>${toolName(tool)}</div>
              <div class="tool-meta">${(tool.ui && tool.ui.short_desc) || ""}</div>
            </div>`;
          bucket.appendChild(row);
        });
        container.appendChild(bucket);
      };

      BUCKETS.forEach((bucket) => {
        const items = bucket.ids.map((id) => toolMap.get(id)).filter(Boolean);
        items.forEach((t) => seen.add(t.tool_id));
        addBucket(bucket.title, bucket.subtitle, items);
      });

      const remaining = toolsState.items.filter((t) => !seen.has(t.tool_id));
      addBucket("Other / ??", "?????", remaining);

      container.querySelectorAll("input[type=checkbox][data-tool-id]").forEach((input) => {
        input.addEventListener("change", () => {
          const id = input.getAttribute("data-tool-id");
          if (!id) return;
          if (input.checked) toolsState.selected.add(id);
          else toolsState.selected.delete(id);
        });
      });
    }

    function selectAllTools() {
      toolsState.selected = new Set(toolsState.items.map((t) => t.tool_id));
      renderTools();
    }

    function selectRecommendedTools() {
      const selected = new Set();
      toolsState.items.forEach((t) => {
        if (t.ui && t.ui.recommended) selected.add(t.tool_id);
      });
      toolsState.selected = selected;
      renderTools();
    }

    function clearTools() {
      toolsState.selected = new Set();
      renderTools();
    }

    async function loadTools() {
      try {
        const res = await fetch("/api/tools");
        if (!res.ok) return;
        const data = await res.json();
        toolsState.items = data.items || [];
        selectAllTools();
      } catch (_) {
        // Ignore tools loading failures; tasks can still be created.
      }
    }

    function updateSummary() {
      const platform = document.getElementById("platform").value;
      const account = document.getElementById("account_id").value;
      const videoType = form.querySelector("input[name='video_type']:checked")?.value || "review";
      const stylePreset = form.querySelector("input[name='style_preset']:checked")?.value || "review_brief";
      document.getElementById("summary-platform").textContent = platform || "-";
      document.getElementById("summary-account").textContent = account || "-";
      document.getElementById("summary-video").textContent = videoType || "-";
      document.getElementById("summary-style").textContent = stylePreset || "-";
    }

    form.addEventListener("change", updateSummary);
    document.addEventListener("DOMContentLoaded", () => {
      updateSummary();
      loadTools();
      document.getElementById("tools-select-all")?.addEventListener("click", selectAllTools);
      document.getElementById("tools-select-recommended")?.addEventListener("click", selectRecommendedTools);
      document.getElementById("tools-clear")?.addEventListener("click", clearTools);
    });

    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      resultEl.textContent = "提交中... / တင်နေသည်...";

      const rawSource = document.getElementById("source_url").value.trim();
      if (!rawSource) {
        alert("必须填写来源链接 / အရင်းအမြစ် URL လိုအပ်သည်");
        resultEl.textContent = "";
        return;
      }
      const platform = document.getElementById("platform").value;
      const account_id = document.getElementById("account_id").value;
      const account_name = document.getElementById("account_name").value;
      const video_type = form.querySelector("input[name='video_type']:checked")?.value || "review";
      const stylePreset = form.querySelector("input[name='style_preset']:checked")?.value || "review_brief";
      const title = document.getElementById("title").value.trim();
      const note = document.getElementById("note").value.trim();
      const selectedToolIds = toolsState.selected.size
        ? Array.from(toolsState.selected)
        : toolsState.items.map((t) => t.tool_id);

      const payload = {
        source_url: rawSource,
        platform,
        account_id,
        account_name,
        video_type,
        template: stylePreset,
        title: title || undefined,
        note: note || undefined,
        selected_tool_ids: selectedToolIds.length ? selectedToolIds : undefined,
        category_key: "suitcase",
        content_lang: "mm",
        ui_lang: "zh",
        style_preset: stylePreset,
        face_swap_enabled: false,
      };

      try {
        const res = await fetch("/api/tasks", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch (_) { /* noop */ }

        if (!res.ok) {
          resultEl.textContent = `Error ${res.status}: ${text}`;
          resultEl.classList.add("error");
          return;
        }

        const taskId = data?.task_id || "(unknown)";
        resultEl.classList.remove("error");
        resultEl.textContent = `已创建任务 ${taskId}, 状态: ${data?.status || "pending"}`;
        setTimeout(() => { window.location.href = "/tasks"; }, 800);
      } catch (err) {
        resultEl.textContent = "请求失败: " + err.message;
        resultEl.classList.add("error");
      }
    });
  </script>
</body>
</html>

