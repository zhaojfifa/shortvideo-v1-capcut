<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Workbench - {{ task.task_id }}</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;600;700&display=swap" />
  <link rel="stylesheet" href="/static/pipeline_lab.css" />
  <link rel="stylesheet" href="/static/i18n.css" />
  <style>
    :root { color-scheme: light; }
    .page.workbench {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .header-card {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .back-link {
      color: #1d4ed8;
      text-decoration: none;
      font-weight: 700;
    }

    .btn-primary {
      background: #2563eb;
      color: #ffffff;
      border: 1px solid #2563eb;
    }
    .btn-primary:hover { filter: brightness(.95); }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      border: 1px solid #d1d5db;
    }
    .btn-secondary:hover { filter: brightness(.98); }
    .btn-primary:disabled,
    .btn-secondary:disabled {
      opacity: 0.7;
      color: #111827;
    }
    h1 { margin: 0; font-size: 1.6rem; font-weight: 800; }
    .status-pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 700;
      background: #e5e7eb;
      color: #374151;
    }
    .badge-ready { background: #dcfce7; color: #15803d; }
    .badge-processing { background: #fef3c7; color: #b45309; }
    .badge-error { background: #fee2e2; color: #b91c1c; }
    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px 16px;
    }
    .meta-item { font-size: 0.95rem; color: #374151; }
    .meta-item strong {
      display: block;
      color: #0f172a;
      font-size: 0.8rem;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .muted { color: #64748b; font-size: 0.85rem; }
    .deliverables-grid { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    .deliverable-card {
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #f8fafc;
    }
    .deliverable-card.primary { border-color: rgba(37, 99, 235, 0.35); background: #eef2ff; }
    .deliverable-title { font-weight: 700; font-size: 1rem; color: #0f172a; }
    .deliverable-actions { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .download-link {
      color: #1d4ed8;
      text-decoration: none;
      font-weight: 700;
    }
    .download-link.disabled { color: #9ca3af; pointer-events: none; }
    .copy-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .copy-btn {
      background: #e2e8f0;
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: 600;
      cursor: pointer;
    }
    .copy-btn:hover { background: #cbd5f5; }
    .info-row { display: flex; flex-wrap: wrap; gap: 12px; }
    .info-pill {
      background: #f1f5f9;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #334155;
    }
    .publish-textarea { width: 100%; min-height: 120px; }
    .steps-grid { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .step-card {
      border: 1px solid rgba(15, 23, 42, 0.08);
      border-radius: 14px;
      padding: 12px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .step-card h3 { margin: 0; font-size: 1rem; }
    pre.output-log {
      background: #0f172a;
      color: #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      max-height: 240px;
      overflow: auto;
      white-space: pre-wrap;
    }
    details.panel summary { cursor: pointer; font-weight: 700; }
    @media (max-width: 768px) {
      .header-row { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="page workbench">
    <div class="card header-card">
      <div class="header-row">
        <a class="back-link back-button btn-secondary" href="/tasks">Back to Task Board <span class="muted">/ 返回任务看板</span></a>
        <div id="status-badge" class="status-pill">{{ task.status }}</div>
      </div>
      <div class="header-row">
        <h1>Task Workbench <span class="muted t-secondary">/ 任务工作台</span></h1>
        <div class="muted t-secondary">Task ID: {{ task.task_id }}</div>
      </div>
      <div class="meta-grid">
        <div class="meta-item"><strong>Task ID <span class="muted t-secondary">/ 任务ID</span></strong><span>{{ task.task_id }}</span></div>
        <div class="meta-item"><strong>Platform <span class="muted t-secondary">/ 平台</span></strong><span>{{ task.platform or '-' }}</span></div>
        <div class="meta-item"><strong>Account <span class="muted t-secondary">/ 账号</span></strong><span>{{ task.account_id or '-' }}</span></div>
        <div class="meta-item"><strong>Category <span class="muted t-secondary">/ 分类</span></strong><span>{{ task.category_key or '-' }}</span></div>
        <div class="meta-item"><strong>Language <span class="muted t-secondary">/ 语种</span></strong><span>{{ task.content_lang or '-' }}</span></div>
        <div class="meta-item"><strong>Status <span class="muted t-secondary">/ 状态</span></strong><span>{{ task.status }}</span></div>
        <div class="meta-item"><strong>Created <span class="muted t-secondary">/ 创建时间</span></strong><span>{{ task.created_at }}</span></div>
        <div class="meta-item">
          <strong>Source URL <span class="muted t-secondary">/ 来源</span></strong>
          {% if task_view.source_url_open %}
            <div><a href="{{ task_view.source_url_open }}" target="_blank" rel="noopener">Open source link</a></div>
          {% else %}
            <div class="muted t-secondary">No clickable URL detected.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="section-title">
        <h2>交付物 <span class="muted t-secondary">/ ပေးပို့ပစ္စည်းများ</span></h2>
        <div class="secondary">运营可下载交付物 / အော်ပရေးရှင်းအတွက် ဒေါင်းလုပ်ပစ္စည်းများ</div>
      </div>
      <div class="section-grid deliverables-grid">
        <div class="deliverable-card primary">
          <div class="deliverable-title">剪辑包 <span class="muted t-secondary">/ အထုပ်</span></div>
          <div class="deliverable-actions">
            <a id="pack-link" class="download-link disabled" href="/v1/tasks/{{ task.task_id }}/pack" target="_blank" rel="noopener">下载 / ဒေါင်းလုပ်</a>
            <span id="pack-status" class="muted t-secondary">未就绪 / မအဆင်သင့်</span>
          </div>
          <div class="muted t-secondary" style="margin-top:6px;">下载将跳转到对象存储链接 / 302 ဖြင့် အရာဝတ္ထုသိုလှောင်သို့</div>
        </div>
        <div class="deliverable-card">
          <div class="deliverable-title">场景包 <span class="muted t-secondary">/ အပိုင်းခွဲ (Scenes)</span></div>
          <div class="deliverable-actions">
            <a id="scenes-link" class="download-link disabled" href="/v1/tasks/{{ task.task_id }}/scenes" target="_blank" rel="noopener">下载 Scenes.zip / Scenes.zip ဒေါင်းလုပ်</a>
            <span id="scenes-status" class="muted t-secondary">未就绪 / မအဆင်သင့်</span>
          </div>
          <div class="muted t-secondary" style="margin-top:6px;">下载 → 解压 → 打开视频与字幕 / ဒေါင်းလုပ် → ဖြုတ်ထုတ် → ဗီဒီယိုနှင့် စာတန်းထိုးဖွင့်</div>
        </div>
        <div class="deliverable-card">
          <div class="deliverable-title">视频 <span class="muted t-secondary">/ ဗီဒီယို</span></div>
          <div class="deliverable-actions">
            <a id="raw-link" class="download-link disabled" href="/v1/tasks/{{ task.task_id }}/raw" target="_blank" rel="noopener">raw.mp4</a>
            <span id="video-status" class="muted t-secondary">未就绪 / မအဆင်သင့်</span>
          </div>
        </div>
        <div class="deliverable-card">
          <div class="deliverable-title">缅文字幕 <span class="muted t-secondary">/ မြန်မာစာတန်းထိုး</span></div>
          <div class="deliverable-actions">
            <a id="mm-link" class="download-link disabled" href="/v1/tasks/{{ task.task_id }}/subs_mm" target="_blank" rel="noopener">mm.srt</a>
            <a id="mm-txt-link" class="download-link disabled" href="/v1/tasks/{{ task.task_id }}/mm_txt" target="_blank" rel="noopener">mm.txt</a>
            <a id="origin-link" class="download-link disabled" href="/v1/tasks/{{ task.task_id }}/subs_origin" target="_blank" rel="noopener">origin.srt</a>
            <span id="subs-status" class="muted t-secondary">未就绪 / မအဆင်သင့်</span>
          </div>
        </div>
        <div class="deliverable-card">
          <div class="deliverable-title">缅语配音 <span class="muted t-secondary">/ မြန်မာအသံ</span></div>
          <div class="deliverable-actions">
            <a id="audio-link" class="download-link disabled" href="/v1/tasks/{{ task.task_id }}/audio_mm" target="_blank" rel="noopener">mm_audio</a>
            <span id="audio-status" class="muted t-secondary">未就绪 / မအဆင်သင့်</span>
          </div>
          <audio id="audio-preview" controls style="display:none; width: 100%; margin-top:6px;"></audio>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="section-title">
        <h2>场景切片 (Scenes) <span class="muted t-secondary">/ အပိုင်းခွဲ (Scenes)</span></h2>
        <div class="secondary">用于运营复用的场景切片 / အော်ပရေးရှင်းအသုံးပြုရန် Scene အပိုင်းများ</div>
      </div>
      <div class="section-grid" style="margin-top:12px;">
        <div class="field">
          <label>说明 / ရှင်းလင်းချက်</label>
          <div class="muted t-secondary" style="white-space:pre-wrap;">
中文：
生成 Scenes 会把本次 Task 的视频按字幕时间切成多个“可复用片段（MSC）”，并打包为 Scenes.zip。
用法：先点“生成场景切片”，状态变为 Ready 后点“下载 Scenes.zip”。无需打开或编辑 JSON。

缅文：
Scenes ကို စာတန်းထိုးအချိန်အလိုက် ဗီဒီယိုကို အပိုင်းများ (MSC) ခွဲပြီး Scenes.zip အဖြစ် ထုတ်ပေးပါတယ်။
အသုံးပြုရန် — “Scenes ထုတ်မည်” ကိုနှိပ်ပြီး Ready ဖြစ်သွားလျှင် “Scenes.zip ဒေါင်းလုပ်” ကိုနှိပ်ပါ။ JSON ကို မဖွင့်လည်း ရပါတယ်။
          </div>
          <div class="muted t-secondary" style="margin-top:8px;">
中文：Scenes.zip 不会影响 Pack.zip，两个包用途不同。<br/>
缅文：Scenes.zip သည် Pack.zip ကို မပြောင်းလဲပါ (နှစ်ခု用途 မတူပါ)။
          </div>
        </div>
        <div class="field">
          <label>操作 / လုပ်ဆောင်ချက်များ</label>
          <div class="action-row" style="margin-top:8px; flex-wrap:wrap; gap:8px;">
            <button id="btn-scenes" class="btn-primary">生成场景切片 / Scenes ထုတ်</button>
            <a id="btn-scenes-download" class="btn-secondary disabled" href="/v1/tasks/{{ task.task_id }}/scenes" target="_blank" rel="noopener">下载 Scenes.zip / Scenes.zip ဒေါင်းလုပ်</a>
            <span id="scenes-step-status" class="muted">未就绪 / မအဆင်သင့်</span>
          </div>
          <div id="scenes-error" class="muted t-secondary" style="margin-top:6px;"></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="section-title">
        <h2>发布信息 <span class="muted t-secondary">/ ထုတ်ဝေမှုအချက်အလက်</span></h2>
        <div class="secondary">运营交付信息 / အော်ပရေးရှင်းအသုံးပြုရန်အချက်အလက်</div>
      </div>
      <div class="info-row">
        <div class="info-pill">引擎 / ပံ့ပိုးသူ: <span id="publish-provider">-</span></div>
        <div class="info-pill">状态 / အခြေအနေ: <span id="publish-status">-</span></div>
        <div class="info-pill">已发布 / ထုတ်ဝေပြီး: <span id="published-at">-</span></div>
      </div>
      <div class="section-grid" style="margin-top:12px;">
        <div class="field">
          <label>发布Key <span class="muted t-secondary">/ ထုတ်ဝေ Key</span></label>
          <div class="copy-row">
            <code id="publish-key">-</code>
            <button type="button" class="copy-btn" data-copy-target="publish-key">复制 / ကူးယူ</button>
          </div>
        </div>
        <div class="field">
          <label>发布链接 <span class="muted t-secondary">/ ထုတ်ဝေလင့်ခ်</span></label>
          <div class="copy-row">
            <a id="publish-url" href="#" target="_blank" rel="noopener">-</a>
            <button type="button" class="copy-btn" data-copy-target="publish-url">复制 / ကူးယူ</button>
          </div>
        </div>
      </div>
      <div class="field" style="margin-top:12px;">
        <label>Publishing Text (မြန်မာ) <span class="muted t-secondary">/ 发布文案</span></label>
        <div class="copy-row">
          <button type="button" class="copy-btn" id="copy-publish-text">复制 / ကူးယူ</button>
          <span class="muted t-secondary">来自缅文文本 / မြန်မာစာသားမှ</span>
        </div>
        <textarea id="publish-text" class="publish-textarea" readonly></textarea>
      </div>
      <div class="action-row" style="margin-top:12px;">
        <button id="publish-btn" class="btn-success">立即发布 <span class="muted t-secondary">/ ယခုပဲထုတ်ဝေ</span></button>
      </div>
    </div>

    <div class="panel">
      <div class="section-title">
        <h2>流程 <span class="muted t-secondary">/ လုပ်ငန်းစဉ်</span></h2>
        <div class="secondary">运营流程视图 / အော်ပရေးရှင်းကြည့်ရှုမှု</div>
      </div>
      <div class="section-grid steps-grid">
        <div class="step-card">
          <h3>步骤1 - 解析与下载 <span class="muted t-secondary">/ ခွဲခြမ်းစိတ်ဖြာ</span></h3>
          <p class="muted t-secondary">调用 /api/tasks/{id}/parse / /api/tasks/{id}/parse ကို ခေါ်ပါ</p>
          <div class="action-row">
            <button id="btn-parse" class="btn-primary">运行解析 <span class="muted t-secondary">/ ခွဲခြမ်းစိတ်ဖြာ</span></button>
            <span id="parse-status" class="muted t-secondary">未解析 / မပြီးသေး</span>
          </div>
        </div>
        <div class="step-card">
          <h3>步骤3 - 缅语配音 <span class="muted">/ မြန်မာအသံ</span></h3>
          <div class="form-grid">
            <div class="field">
              <label for="voice-id">音色 <span class="muted">/ အသံအရည်အသွေး</span></label>
              <select id="voice-id">
                <option value="mm_female_1">mm_female_1</option>
                <option value="mm_male_1">mm_male_1</option>
                <option value="mm_female_2">mm_female_2</option>
              </select>
            </div>
            <div class="field">
              <label for="dub-provider">引擎 <span class="muted">/ ပံ့ပိုးသူ</span></label>
              <select id="dub-provider">
                <option value="edge-tts">edge-tts</option>
                <option value="lovo">lovo</option>
              </select>
            </div>
          </div>
          <div class="action-row" style="margin-top:8px;">
            <button id="btn-dub" class="btn-primary">生成配音 <span class="muted t-secondary">/ အသံထုတ်</span></button>
            <span id="dub-status" class="muted">未就绪 / မအဆင်သင့်</span>
          </div>
        </div>
        <div class="step-card">
          <h3>步骤4 - 打包 <span class="muted">/ အထုပ်</span></h3>
          <p class="muted">生成本任务剪辑包 / ဤတာဝန်အတွက် အထုပ်ထုတ်</p>
          <div class="action-row">
            <button id="btn-pack" class="btn-primary">生成剪辑包 <span class="muted t-secondary">/ အထုပ်ထုတ်</span></button>
            <span id="pack-step-status" class="muted">未就绪 / မအဆင်သင့်</span>
          </div>
        </div>
        <div class="step-card step-wide">
          <h3>步骤2 - 字幕 <span class="muted">/ စာတန်းထိုး</span></h3>
          <p class="muted">调用 /api/tasks/{id}/subtitles 生成字幕 / /api/tasks/{id}/subtitles ကို အသုံးပြုပါ</p>
          <div class="action-row">
            <button id="btn-subtitles" class="btn-primary">生成字幕 <span class="muted t-secondary">/ စာတန်းထိုးထုတ်</span></button>
            <span id="subs-step-status" class="muted t-secondary">未就绪 / မအဆင်သင့်</span>
          </div>
          <details id="subs-compare" style="margin-top:10px;">
            <summary>对比字幕 <span class="muted t-secondary">/ စာတန်းထိုးနှိုင်းယှဉ်</span></summary>
            <div style="margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
              <div>
                <div class="copy-row" style="justify-content:space-between;">
                  <label style="margin:0;">原始 <span class="muted t-secondary">/ မူရင်း</span></label>
                  <button type="button" id="btn-copy-origin" class="copy-btn">复制 / ကူးယူ</button>
                </div>
                <pre id="origin-text" class="output"></pre>
              </div>
              <div>
                <div class="copy-row" style="justify-content:space-between;">
                  <label style="margin:0;">缅文 <span class="muted t-secondary">/ မြန်မာ</span></label>
                  <button type="button" id="btn-copy-mm" class="copy-btn">复制 / ကူးယူ</button>
                </div>
                <pre id="mm-text" class="output"></pre>
              </div>
            </div>

            <div style="margin-top:12px;">
              <div class="copy-row" style="justify-content:space-between;">
                <label for="mm-edit" style="margin:0;">缅文编辑 (mm_edited.txt) <span class="muted t-secondary">/ မြန်မာတည်းဖြတ်</span></label>
                <div class="copy-row">
                  <button type="button" id="btn-load-edited" class="copy-btn">刷新 / ပြန်တင်</button>
                  <button type="button" id="btn-save-edited" class="copy-btn">保存 / သိမ်း</button>
                </div>
              </div>
              <textarea id="mm-edit" rows="6" style="width:100%; margin-top:8px;"></textarea>
              <div class="muted t-secondary" id="mm-edit-status" style="margin-top:6px;">-</div>
            </div>
            <div style="margin-top:12px;">
              <div class="copy-row" style="justify-content:space-between;">
                <label for="mm-text-override" style="margin:0;">MM 文本修订 (仅用于本次配音) <span class="muted t-secondary">/ ဒီတစ်ကြိမ်အသံထုတ်ရန်သာ အသုံးပြုမည့် စာသား</span></label>
              </div>
              <textarea id="mm-text-override" rows="6" style="width:100%; margin-top:8px;" placeholder="仅本次配音使用，不会覆盖字幕文件 / ဒီတစ်ကြိမ်အသံထုတ်ရန်သာ၊ စာတန်းထိုးဖိုင် မပြောင်းပါ"></textarea>
              <div class="muted t-secondary" style="margin-top:6px;">仅用于本次重新配音，不会覆盖字幕文件 / ဒီတစ်ကြိမ်အသံထုတ်ရန်သာ၊ စာတန်းထိုးဖိုင် မပြောင်းပါ</div>
            </div>
          </details>
        </div>
      </div>
    </div>

    <details class="panel" id="debug-panel">
      <summary>Logs &amp; Debug <span class="muted t-secondary">/ 日志与调试</span></summary>
      <div style="margin-top:12px;">
        <h3 style="margin:0 0 8px;">Logs <span class="muted t-secondary">/ 日志</span></h3>
        <pre id="log-output" class="output-log">Ready.</pre>
      </div>
      <div style="margin-top:12px;">
        <h3 style="margin:0 0 8px;">Engineering details <span class="muted t-secondary">/ 工程信息</span></h3>
        <div class="env-grid">
          <div class="env-card"><div class="env-label"><span>Workspace</span></div><div class="env-value">{{ env_summary.workspace_root }}</div></div>
          <div class="env-card"><div class="env-label"><span>Douyin API</span></div><div class="env-value">{{ env_summary.douyin_api_base }}</div></div>
          <div class="env-card"><div class="env-label"><span>ASR</span></div><div class="env-value">{{ env_summary.asr_backend }}</div></div>
          <div class="env-card"><div class="env-label"><span>Subtitles</span></div><div class="env-value">{{ env_summary.subtitles_backend }}</div></div>
          <div class="env-card"><div class="env-label"><span>Whisper</span></div><div class="env-value">{{ env_summary.whisper_model }}</div></div>
          <div class="env-card"><div class="env-label"><span>Gemini</span></div><div class="env-value">{{ env_summary.gemini_model }}</div></div>
          <div class="env-card"><div class="env-label"><span>GPT</span></div><div class="env-value">{{ env_summary.gpt_model }}</div></div>
          {% if env_summary.defaults %}
          <div class="env-card"><div class="env-label"><span>Defaults</span></div><div class="env-value">{{ env_summary.defaults }}</div></div>
          {% endif %}
        </div>
        <div style="margin-top:10px;" class="section-grid">
          <div class="field">
            <label>Origin Subtitles <span class="muted t-secondary">/ 工程用</span></label>
            <div class="muted t-secondary">See deliverables above.</div>
          </div>
          <div class="field">
            <label>Source URL (raw) <span class="muted t-secondary">/ 原始文本</span></label>
            <div class="muted t-secondary" style="white-space:pre-wrap; word-break:break-word;">{{ task.source_url or '-' }}</div>
          </div>
        </div>
      </div>
    </details>
  </div>

  <script>
    window.__FEATURES__ = {{ features | tojson | safe }};
    window.currentTask = {{ task_json | tojson | safe }};

    function appendLog(line) {
      const logEl = document.getElementById("log-output");
      if (!logEl) return;
      const now = new Date().toISOString();
      logEl.textContent += `\n[${now}] ${line}`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateStatusBadge(data) {
      const badge = document.getElementById("status-badge");
      if (!badge) return;
      const status = data.status || "unknown";
      badge.textContent = status;
      badge.className = `status-pill ${status === "ready"
        ? "badge-ready"
        : status === "processing"
        ? "badge-processing"
        : status === "error"
        ? "badge-error"
        : "badge-unknown"}`;
    }

    function setDownloadLink(id, href) {
      const el = document.getElementById(id);
      if (!el) return;
      if (href) {
        el.href = href;
        el.classList.remove("disabled");
        el.removeAttribute("aria-disabled");
      } else {
        el.href = "#";
        el.classList.add("disabled");
        el.setAttribute("aria-disabled", "true");
      }
    }

    function setStatusText(id, isReady, readyText, missingText) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = isReady ? readyText : missingText;
    }

    function taskEndpoint(taskId, kind) {
      const id = encodeURIComponent(taskId);
      const map = {
        raw: `/v1/tasks/${id}/raw`,
        origin_srt: `/v1/tasks/${id}/subs_origin`,
        mm_srt: `/v1/tasks/${id}/subs_mm`,
        mm_txt: `/v1/tasks/${id}/mm_txt`,
        audio_mm: `/v1/tasks/${id}/audio_mm`,
        pack: `/v1/tasks/${id}/pack`,
        scenes: `/v1/tasks/${id}/scenes`,
      };
      return map[kind] || null;
    }

    function isPresignedLike(url) {
      if (!url) return false;
      const u = String(url);
      return /X-Amz-|Signature=|cloudflarestorage|AWS4-HMAC-SHA256/i.test(u);
    }

    function updateDownloadsFromTask(data) {
      const taskId = data.task_id;
      const hasRaw = !!data.raw_path;
      const hasOrigin = !!data.origin_srt_path;
      const hasMmSrt = !!data.mm_srt_path;
      const hasMmTxt = !!(data.mm_txt_path || data.mm_srt_path);
      const hasAudio = !!data.mm_audio_path;
      const hasPack = !!data.pack_path;
      const hasScenes = !!data.scenes_path;

      setDownloadLink("raw-link", hasRaw ? taskEndpoint(taskId, "raw") : null);
      setDownloadLink("origin-link", hasOrigin ? taskEndpoint(taskId, "origin_srt") : null);
      setDownloadLink("mm-link", hasMmSrt ? taskEndpoint(taskId, "mm_srt") : null);
      setDownloadLink("mm-txt-link", hasMmTxt ? taskEndpoint(taskId, "mm_txt") : null);
      setDownloadLink("audio-link", hasAudio ? taskEndpoint(taskId, "audio_mm") : null);
      setDownloadLink("pack-link", hasPack ? taskEndpoint(taskId, "pack") : null);
      setDownloadLink("scenes-link", hasScenes ? taskEndpoint(taskId, "scenes") : null);
      setDownloadLink("btn-scenes-download", hasScenes ? taskEndpoint(taskId, "scenes") : null);

      setStatusText("video-status", hasRaw, "已就绪 / အဆင်သင့်", "未就绪 / မအဆင်သင့်");
      setStatusText("subs-status", hasMmSrt || hasMmTxt, "已就绪 / အဆင်သင့်", "未就绪 / မအဆင်သင့်");
      setStatusText("audio-status", hasAudio, "已就绪 / အဆင်သင့်", "未就绪 / မအဆင်သင့်");
      setStatusText("pack-status", hasPack, "已就绪 / အဆင်သင့်", "未就绪 / မအဆင်သင့်");
      setStatusText("scenes-status", hasScenes, "已就绪 / အဆင်သင့်", "未就绪 / မအဆင်သင့်");

      const audioEl = document.getElementById("audio-preview");
      if (audioEl) {
        if (hasAudio) {
          audioEl.src = taskEndpoint(taskId, "audio_mm");
          audioEl.style.display = "block";
        } else {
          audioEl.removeAttribute("src");
          audioEl.style.display = "none";
        }
      }
    }

    function updateStepStatuses(data) {
      const hasRaw = !!data.raw_path;
      const hasSubs = data.subtitles_status === "ready" || !!(data.mm_srt_path || data.origin_srt_path);
      const hasAudio = !!data.mm_audio_path;
      const hasPack = !!data.pack_path;

      setStatusText("parse-status", hasRaw, "已解析 / ပြီးသည်", "未解析 / မပြီးသေး");
      setStatusText("subs-step-status", hasSubs, "已就绪 / အဆင်သင့်", "未就绪 / မအဆင်သင့်");
      setStatusText("dub-status", hasAudio, "已就绪 / အဆင်သင့်", "未就绪 / မအဆင်သင့်");
      setStatusText("pack-step-status", hasPack, "已就绪 / အဆင်သင့်", "未就绪 / မအဆင်သင့်");
    }

    function renderScenesStatus(data) {
      const status = data.scenes_status || (data.scenes_path ? "ready" : "unknown");
      const statusEl = document.getElementById("scenes-step-status");
      const errorEl = document.getElementById("scenes-error");
      const map = {
        queued: "处理中… / လုပ်ဆောင်နေသည်…",
        running: "处理中… / လုပ်ဆောင်နေသည်…",
        ready: "已就绪 / အဆင်သင့်",
        error: `失败：${data.scenes_error || "unknown"} / မအောင်မြင်ပါ：${data.scenes_error || "unknown"}`,
        already_ready: "已就绪 / အဆင်သင့်",
      };
      if (statusEl) {
        statusEl.textContent = map[status] || "未就绪 / မအဆင်သင့်";
      }
      if (errorEl) {
        errorEl.textContent = status === "error" ? (data.scenes_error || "") : "";
      }
      if (status === "queued" || status === "running") {
        startScenesPolling();
      } else {
        stopScenesPolling();
      }
    }

    const SCENES_POLL_INTERVAL_MS = 15000;
    let scenesPoller = null;
    let scenesPollInFlight = false;

    function startScenesPolling() {
      if (document.hidden) return;
      if (scenesPoller) {
        stopScenesPolling();
      }
      scenesPoller = setInterval(() => {
        if (scenesPollInFlight || document.hidden) return;
        scenesPollInFlight = true;
        refreshTaskState()
          .catch(() => {})
          .finally(() => {
            scenesPollInFlight = false;
          });
      }, SCENES_POLL_INTERVAL_MS);
    }

    function stopScenesPolling() {
      if (!scenesPoller) return;
      clearInterval(scenesPoller);
      scenesPoller = null;
    }

    function refreshPublishInfo(data) {
      const provider = data.publish_provider || "-";
      const key = data.publish_key || "-";
      const at = data.published_at || "-";
      const status = data.publish_status || "-";
      const taskId = data.task_id;
      let url = data.publish_url || "-";
      if (url === "-" || isPresignedLike(url)) {
        url = data.pack_path ? taskEndpoint(taskId, "pack") : "-";
      }

      const providerEl = document.getElementById("publish-provider");
      const keyEl = document.getElementById("publish-key");
      const atEl = document.getElementById("published-at");
      const statusEl = document.getElementById("publish-status");
      const urlEl = document.getElementById("publish-url");
      if (providerEl) providerEl.textContent = provider;
      if (keyEl) keyEl.textContent = key;
      if (atEl) atEl.textContent = at;
      if (statusEl) statusEl.textContent = status;
      if (urlEl) {
        urlEl.textContent = url;
        urlEl.href = url === "-" ? "#" : url;
      }
    }

    function copyTextFromElement(el) {
      if (!el) return;
      const text = el.tagName === "A" ? el.getAttribute("href") : el.textContent || "";
      if (!text || text === "#") return;
      navigator.clipboard.writeText(text).catch(() => {});
    }

    document.querySelectorAll("[data-copy-target]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const targetId = btn.getAttribute("data-copy-target");
        const target = document.getElementById(targetId);
        copyTextFromElement(target);
        appendLog(`Copied ${targetId}.`);
      });
    });

    const copyPublishTextBtn = document.getElementById("copy-publish-text");
    if (copyPublishTextBtn) {
      copyPublishTextBtn.addEventListener("click", async () => {
        const text = (document.getElementById("publish-text") || {}).value || "";
        if (text) {
          await navigator.clipboard.writeText(text);
          appendLog("Copied publish text.");
        }
      });
    }

    updateDownloadsFromTask(window.currentTask);
    updateStatusBadge(window.currentTask);
    updateStepStatuses(window.currentTask);
    refreshPublishInfo(window.currentTask);
    renderScenesStatus(window.currentTask);

    let taskRefreshInFlight = false;
    async function refreshTaskState() {
      if (taskRefreshInFlight) return;
      taskRefreshInFlight = true;
      try {
        const taskId = window.currentTask.task_id;
        const resp = await fetch(`/api/tasks/${taskId}`);
        if (!resp.ok) {
          appendLog(`Failed to refresh task: HTTP ${resp.status}`);
          return;
        }
        const data = await resp.json();
        window.currentTask = data;
        updateDownloadsFromTask(data);
        updateStatusBadge(data);
        updateStepStatuses(data);
        refreshPublishInfo(data);
        renderScenesStatus(data);
        if (data.error_message) {
          appendLog(`Last error: ${data.error_message}`);
        }
      } finally {
        taskRefreshInFlight = false;
      }
    }

    document.getElementById("btn-parse").addEventListener("click", async () => {
      const taskId = window.currentTask.task_id;
      const linkText = window.currentTask.source_url || "";
      const platform = window.currentTask.platform || null;
      if (!linkText) {
        appendLog("Parse failed: source_url is empty for this task.");
        return;
      }
      appendLog(`Calling /api/tasks/${taskId}/parse...`);
      const payload = { platform };
      const resp = await fetch(`/api/tasks/${taskId}/parse`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!resp.ok) {
        let errorDetail = `HTTP ${resp.status}`;
        try {
          const payload = await resp.json();
          errorDetail = payload?.detail ? `${errorDetail} - ${payload.detail}` : errorDetail;
        } catch (err) {
          appendLog(`Parse failed: ${errorDetail}`);
          return;
        }
        appendLog(`Parse failed: ${errorDetail}`);
        return;
      }
      appendLog("Parse call finished.");
      await refreshTaskState();
    });

    document.getElementById("btn-subtitles").addEventListener("click", async () => {
      const taskId = window.currentTask.task_id;
      appendLog(`Calling /api/tasks/${taskId}/subtitles...`);
      const resp = await fetch(`/api/tasks/${taskId}/subtitles`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}),
      });
      if (!resp.ok) {
        appendLog(`Subtitles failed: HTTP ${resp.status}`);
        return;
      }
      appendLog("Subtitles call finished.");
      await refreshTaskState();
    });

    document.getElementById("btn-dub").addEventListener("click", async () => {
      const taskId = window.currentTask.task_id;
      const subsReady = window.currentTask.subtitles_status === "ready" || !!window.currentTask.mm_srt_path;
      if (!subsReady) {
        appendLog("Please generate subtitles first / 请先生成字幕 / အရင် စာတန်းထိုးကို ထုတ်ပါ");
        return;
      }
      const voiceId = document.getElementById("voice-id").value;
      const provider = document.getElementById("dub-provider").value || "edge-tts";
      appendLog(`Calling /api/tasks/${taskId}/dub (provider=${provider}, voice=${voiceId})...`);
      const payload = { provider, voice_id: voiceId };
      const overrideEl = document.getElementById("mm-text-override");
      const overrideText = overrideEl ? overrideEl.value.trim() : "";
      if (overrideText) {
        payload.mm_text = overrideText;
      }
      const resp = await fetch(`/api/tasks/${taskId}/dub`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!resp.ok) {
        const detail = await resp.text();
        appendLog(`Dub failed: HTTP ${resp.status} ${detail}`);
        return;
      }
      appendLog("Dub audio ready.");
      await refreshTaskState();
    });

    document.getElementById("btn-pack").addEventListener("click", async () => {
      const taskId = window.currentTask.task_id;
      appendLog(`Calling /api/tasks/${taskId}/pack...`);
      const resp = await fetch(`/api/tasks/${taskId}/pack`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}),
      });
      if (!resp.ok) {
        appendLog(`Pack failed: HTTP ${resp.status}`);
        return;
      }
      appendLog("Pack ready.");
      await refreshTaskState();
    });

    document.getElementById("btn-scenes").addEventListener("click", async () => {
      const taskId = window.currentTask.task_id;
      const subsReady = window.currentTask.subtitles_status === "ready" || !!window.currentTask.mm_srt_path;
      if (!subsReady) {
        appendLog("Please generate subtitles first / 请先生成字幕 / အရင် စာတန်းထိုးကို ထုတ်ပါ");
        return;
      }
      appendLog(`Calling /api/tasks/${taskId}/scenes...`);
      const resp = await fetch(`/api/tasks/${taskId}/scenes`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}),
      });
      if (!resp.ok) {
        appendLog(`Scenes failed: HTTP ${resp.status}`);
        return;
      }
      const payload = await resp.json();
      appendLog(`Scenes status: ${payload.status}`);
      if (payload.status === "queued" || payload.status === "running") {
        startScenesPolling();
      }
      await refreshTaskState();
    });

    const publishBtn = document.getElementById("publish-btn");
    if (publishBtn) {
      publishBtn.addEventListener("click", async () => {
        const taskId = window.currentTask.task_id;
        const statusEl = document.getElementById("publish-status");
        if (statusEl) statusEl.textContent = "Publishing...";
        try {
          const resp = await fetch(`/api/tasks/${taskId}/publish`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ task_id: taskId, force: false }),
          });
          if (!resp.ok) {
            const detail = await resp.text();
            if (statusEl) statusEl.textContent = `Publish failed: ${resp.status} ${detail}`;
            return;
          }
          if (statusEl) statusEl.textContent = "Published.";
          await refreshTaskState();
        } catch (err) {
          if (statusEl) statusEl.textContent = `Publish error: ${err}`;
        }
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      refreshTaskState().catch((err) => {
        console.error(err);
        appendLog("Initial refresh failed: " + err);
      });
    });

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        stopScenesPolling();
      } else if (window.currentTask && window.currentTask.scenes_status) {
        const status = window.currentTask.scenes_status;
        if (status === "queued" || status === "running") {
          startScenesPolling();
        }
      }
    });

    window.addEventListener("beforeunload", () => {
      stopScenesPolling();
    });

    async function fetchTextOrFallback(url, fallbackMessage) {
      try {
        const resp = await fetch(url, { method: "GET" });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        return await resp.text();
      } catch (err) {
        console.warn("fetchText failed", url, err);
        return fallbackMessage || `Failed to load. You can use download links above. (${url})`;
      }
    }

    async function loadCompareBlock(forceReload) {
      const taskId = window.currentTask.task_id;
      const originPre = document.getElementById("origin-text");
      const mmPre = document.getElementById("mm-text");
      const mmEdit = document.getElementById("mm-edit");
      const statusEl = document.getElementById("mm-edit-status");
      const publishText = document.getElementById("publish-text");
      const overrideEl = document.getElementById("mm-text-override");
      if (!originPre || !mmPre || !mmEdit) return;

      if (!forceReload && originPre.getAttribute("data-loaded") === "1") {
        return;
      }

      originPre.textContent = "Loading...";
      mmPre.textContent = "Loading...";
      if (statusEl) statusEl.textContent = "Loading...";

      const originUrl = `/api/tasks/${encodeURIComponent(taskId)}/text?kind=origin_srt`;
      const mmTxtUrl = `/api/tasks/${encodeURIComponent(taskId)}/text?kind=mm_txt`;

      const originText = await fetchTextOrFallback(
        originUrl,
        "Unable to load origin subtitles in-browser (possible CORS redirect). Use Downloads -> origin.srt."
      );
      const mmText = await fetchTextOrFallback(
        mmTxtUrl,
        "Unable to load mm text in-browser (possible CORS redirect). Use Downloads -> mm.txt."
      );
      originPre.textContent = originText || "";
      mmPre.textContent = mmText || "";
      if (publishText && !publishText.value) publishText.value = mmText || "";
      if (overrideEl && !overrideEl.value.trim()) {
        const candidate = (mmText || "").trim();
        if (candidate && !candidate.startsWith("Unable to load") && !candidate.startsWith("Failed to load")) {
          overrideEl.value = mmText;
        }
      }
      originPre.setAttribute("data-loaded", "1");

      try {
        const editedUrl = `/api/tasks/${encodeURIComponent(taskId)}/text?kind=mm_edited`;
        const r = await fetch(editedUrl);
        if (r.ok) {
          const text = await r.text();
          if (text && text.trim().length > 0) {
            mmEdit.value = text;
            if (statusEl) statusEl.textContent = "Loaded mm_edited.txt";
          } else {
            mmEdit.value = mmText || "";
            if (statusEl) statusEl.textContent = "No mm_edited.txt; initialized from mm.txt";
          }
        } else {
          mmEdit.value = mmText || "";
          if (statusEl) statusEl.textContent = `mm_edited load failed: HTTP ${r.status} (fallback to mm.txt)`;
        }
      } catch (err) {
        mmEdit.value = mmText || "";
        if (statusEl) statusEl.textContent = "mm_edited load error (fallback to mm.txt)";
      }
    }

    const detailsEl = document.getElementById("subs-compare");
    if (detailsEl) {
      detailsEl.addEventListener("toggle", () => {
        if (detailsEl.open) loadCompareBlock(false);
      });
    }

    const copyBtnOrigin = document.getElementById("btn-copy-origin");
    if (copyBtnOrigin) {
      copyBtnOrigin.addEventListener("click", async () => {
        const t = (document.getElementById("origin-text") || {}).textContent || "";
        await navigator.clipboard.writeText(t);
        appendLog("Copied origin subtitles.");
      });
    }

    const copyBtnMm = document.getElementById("btn-copy-mm");
    if (copyBtnMm) {
      copyBtnMm.addEventListener("click", async () => {
        const t = (document.getElementById("mm-text") || {}).textContent || "";
        await navigator.clipboard.writeText(t);
        appendLog("Copied mm text.");
      });
    }

    const btnReload = document.getElementById("btn-load-edited");
    if (btnReload) {
      btnReload.addEventListener("click", async () => {
        await loadCompareBlock(true);
        appendLog("Reloaded compare block.");
      });
    }

    const btnSave = document.getElementById("btn-save-edited");
    if (btnSave) {
      btnSave.addEventListener("click", async () => {
        const taskId = window.currentTask.task_id;
        const mmEdit = document.getElementById("mm-edit");
        const statusEl = document.getElementById("mm-edit-status");
        const text = mmEdit ? mmEdit.value : "";
        if (statusEl) statusEl.textContent = "Saving...";
        try {
          const resp = await fetch(`/api/tasks/${encodeURIComponent(taskId)}/mm_edited`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
          });
          if (!resp.ok) {
            const detail = await resp.text();
            if (statusEl) statusEl.textContent = `Save failed: HTTP ${resp.status} ${detail}`;
            appendLog(`Save mm_edited failed: HTTP ${resp.status}`);
            return;
          }
          if (statusEl) statusEl.textContent = "Saved mm_edited.txt";
          appendLog("Saved mm_edited.txt");
        } catch (err) {
          if (statusEl) statusEl.textContent = `Save error: ${err}`;
          appendLog("Save mm_edited error: " + err);
        }
      });
    }
  </script>
</body>
</html>

