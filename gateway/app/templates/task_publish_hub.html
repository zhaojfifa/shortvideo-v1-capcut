{% macro _i18n_fallback(key) -%}{{ key }}{%- endmacro %}
{% if t_primary is not defined %}{% set t_primary = _i18n_fallback %}{% endif %}
{% if t_secondary is not defined %}{% set t_secondary = _i18n_fallback %}{% endif %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Publish Hub - {{ task.task_id }}</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;600;700&display=swap" />
  <link rel="stylesheet" href="/static/pipeline_lab.css" />
  <link rel="stylesheet" href="/static/i18n.css" />
  <style>
    :root { color-scheme: light; }
    body {
      margin: 0;
      background: #f3f4f6;
    }
    .page.publish {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 16px;
    }
    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    h1 { margin: 0; font-size: 1.6rem; font-weight: 800; }
    .btn-primary {
      background: #2563eb;
      color: #ffffff;
      border: 1px solid #2563eb;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      border: 1px solid #d1d5db;
    }
    .btn-primary,
    .btn-secondary {
      padding: 8px 12px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 700;
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }
    .btn-primary:hover { filter: brightness(.95); }
    .btn-secondary:hover { filter: brightness(.98); }
    .muted { color: #64748b; font-size: 0.85rem; }
    .section-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
    }
    .link-row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .download-link {
      color: #1d4ed8;
      text-decoration: none;
      font-weight: 700;
    }
    .download-link.disabled { color: #9ca3af; pointer-events: none; }
    .info-row { display: flex; flex-wrap: wrap; gap: 12px; }
    .info-pill {
      background: #f1f5f9;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #334155;
    }
    .copy-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .copy-btn {
      background: #e2e8f0;
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: 600;
      cursor: pointer;
    }
    .copy-btn:hover { background: #cbd5f5; }
    .publish-textarea { width: 100%; min-height: 120px; }
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .tab-btn {
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer;
    }
    .tab-btn.active {
      background: #111827;
      color: #ffffff;
      border-color: #111827;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .bilingual { display: flex; flex-direction: column; gap: 4px; }
    .qr-placeholder {
      width: 180px;
      height: 180px;
      border: 1px dashed #cbd5e1;
      background: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-weight: 600;
      text-align: center;
      padding: 12px;
    }
  </style>
</head>
<body>
  <div class="page publish">
    <div class="card">
      <div class="header-row">
        <div>
          {% set publish_secondary = t_secondary("publish") %}
          <h1>Publish Hub{% if publish_secondary %} <span class="muted t-secondary">/ {{ publish_secondary }}</span>{% endif %}</h1>
          {% set id_secondary = t_secondary("id") %}
          <div class="muted">{{ t_primary("id") }}: {{ task.task_id }}{% if id_secondary %} <span class="t-secondary">/ {{ id_secondary }}</span>{% endif %}</div>
        </div>
        <div class="copy-row">
          <a class="btn-secondary" href="/tasks">Back to Task Board</a>
          <a class="btn-primary" href="/tasks/{{ task.task_id }}">Back to Workbench</a>
        </div>
      </div>
      <div class="info-row" style="margin-top:10px;">
        <div class="info-pill">Download code: <span id="download-code">{{ task.task_id[:6]|upper }}</span></div>
      </div>
    </div>

    <div class="card" id="op-gate" style="display:none;">
      <div class="section-title">
        <h2>Operator Gate</h2>
        <div class="secondary">Enter OP access key to load Publish Hub data.</div>
      </div>
      <div class="copy-row" style="margin-top:10px;">
        <input id="op-key-input" class="publish-textarea" placeholder="OP access key" />
        <button type="button" class="btn-primary" id="op-key-save">Unlock</button>
        <span id="op-key-status" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <div class="tabs" role="tablist">
        <button class="tab-btn active" data-tab="tab-sop" type="button">SOP</button>
        <button class="tab-btn" data-tab="tab-copy" type="button">Copy Bundle</button>
        <button class="tab-btn" data-tab="tab-deliverables" type="button">Deliverables</button>
        <button class="tab-btn" data-tab="tab-archive" type="button">Archive</button>
      </div>
    </div>

    <div class="tab-panel active" id="tab-sop">
      <div class="card">
        <div class="section-title">
          <h2>SOP</h2>
          <div class="secondary">Operational steps for v1.85 delivery.</div>
        </div>
        <div class="bilingual">
          <div>1) Download the edit pack (pack.zip) from Deliverables.</div>
          <div class="muted t-secondary">/ 1) 下载编辑包（pack.zip）。</div>
        </div>
        <div class="bilingual" style="margin-top:8px;">
          <div>2) Import to phone or CapCut, finish the edit.</div>
          <div class="muted t-secondary">/ 2) 导入手机或剪映完成剪辑。</div>
        </div>
        <div class="bilingual" style="margin-top:8px;">
          <div>3) Use Copy Bundle for caption and hashtags.</div>
          <div class="muted t-secondary">/ 3) 使用 Copy Bundle 复制文案与标签。</div>
        </div>
        <div class="bilingual" style="margin-top:8px;">
          <div>4) Publish manually (Publish Bundle comes in v2.0).</div>
          <div class="muted t-secondary">/ 4) 手动发布（发布包将在 2.0 提供）。</div>
        </div>
      </div>
    </div>

    <div class="tab-panel" id="tab-copy">
      <div class="card">
        <div class="section-title">
          <h2>Copy Bundle</h2>
          <div class="secondary">Editable fields for operators. Changes are not saved.</div>
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Caption</label>
          <div class="copy-row">
            <button type="button" class="copy-btn" data-copy-target="copy-caption">Copy</button>
          </div>
          <textarea id="copy-caption" class="publish-textarea"></textarea>
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Hashtags</label>
          <div class="copy-row">
            <button type="button" class="copy-btn" data-copy-target="copy-hashtags">Copy</button>
          </div>
          <textarea id="copy-hashtags" class="publish-textarea"></textarea>
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Comment CTA</label>
          <div class="copy-row">
            <button type="button" class="copy-btn" data-copy-target="copy-comment-cta">Copy</button>
          </div>
          <textarea id="copy-comment-cta" class="publish-textarea"></textarea>
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Link Text</label>
          <div class="copy-row">
            <button type="button" class="copy-btn" data-copy-target="copy-link-text">Copy</button>
          </div>
          <textarea id="copy-link-text" class="publish-textarea"></textarea>
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Publish Time Suggestion</label>
          <div class="copy-row">
            <button type="button" class="copy-btn" data-copy-target="copy-publish-time">Copy</button>
          </div>
          <textarea id="copy-publish-time" class="publish-textarea"></textarea>
        </div>
      </div>
    </div>

    <div class="tab-panel" id="tab-deliverables">
      <div class="card">
        <div class="section-title">
          {% set deliverables_secondary = t_secondary("download") %}
          <h2>Deliverables{% if deliverables_secondary %} <span class="muted t-secondary">/ {{ deliverables_secondary }}</span>{% endif %}</h2>
          <div class="secondary">Only existing artifacts are shown.</div>
        </div>
        <div id="deliverables-list" class="copy-row" style="margin-top:12px;"></div>
        <div class="muted" id="deliverables-empty" style="margin-top:8px; display:none;">No deliverables yet.</div>
        <div class="copy-row" style="margin-top:12px;">
          <a id="edit-bundle-link" class="btn-primary" href="#" target="_blank" rel="noopener">Edit Bundle (ZIP)</a>
        </div>
        <div class="copy-row" style="margin-top:12px;">
          <div id="qr-box" class="qr-placeholder">QR will appear here</div>
          <div class="muted">QR points to short link</div>
        </div>
      </div>
    </div>

    <div class="tab-panel" id="tab-archive">
      <div class="card">
        <div class="section-title">
          {% set publish_secondary = t_secondary("publish") %}
          <h2>{{ t_primary("publish") }}{% if publish_secondary %} <span class="muted t-secondary">/ {{ publish_secondary }}</span>{% endif %}</h2>
          <div class="secondary">Archive confirms delivery, not necessarily published.</div>
        </div>
        <div class="info-row">
          {% set provider_secondary = t_secondary("publish_provider") %}
          <div class="info-pill">{{ t_primary("publish_provider") }}{% if provider_secondary %} <span class="t-secondary">/ {{ provider_secondary }}</span>{% endif %}: <span id="publish-provider">-</span></div>
          {% set status_secondary = t_secondary("status") %}
          <div class="info-pill">{{ t_primary("status") }}{% if status_secondary %} <span class="t-secondary">/ {{ status_secondary }}</span>{% endif %}: <span id="publish-status">-</span></div>
          {% set published_secondary = t_secondary("published") %}
          <div class="info-pill">{{ t_primary("published") }}{% if published_secondary %} <span class="t-secondary">/ {{ published_secondary }}</span>{% endif %}: <span id="published-at">-</span></div>
        </div>
        <div class="section-grid" style="margin-top:12px;">
          <div class="field">
            {% set key_secondary = t_secondary("publish_key") %}
            <label>{{ t_primary("publish_key") }}{% if key_secondary %} <span class="muted t-secondary">/ {{ key_secondary }}</span>{% endif %}</label>
            <div class="copy-row">
              <code id="publish-key">-</code>
              <button type="button" class="copy-btn" data-copy-target="publish-key">Copy</button>
            </div>
          </div>
          <div class="field">
            {% set url_secondary = t_secondary("publish_url") %}
            <label>{{ t_primary("publish_url") }}{% if url_secondary %} <span class="muted t-secondary">/ {{ url_secondary }}</span>{% endif %}</label>
            <div class="copy-row">
              <a id="publish-url" href="#" target="_blank" rel="noopener">-</a>
              <button type="button" class="copy-btn" data-copy-target="publish-url">Copy</button>
            </div>
          </div>
        </div>
        <div class="action-row" style="margin-top:12px;">
          {% set publish_now_secondary = t_secondary("publish_now") %}
          <button id="publish-btn" class="btn-success">{{ t_primary("publish_now") }}{% if publish_now_secondary %} <span class="muted t-secondary">/ {{ publish_now_secondary }}</span>{% endif %}</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const TASK_ID = "{{ task.task_id }}";
    const OP_KEY_STORAGE = "op_access_key";

    function getOpKey() {
      return sessionStorage.getItem(OP_KEY_STORAGE) || "";
    }

    function setOpKey(value) {
      sessionStorage.setItem(OP_KEY_STORAGE, value);
    }

    function showGate(message) {
      const gate = document.getElementById("op-gate");
      if (gate) gate.style.display = "";
      const statusEl = document.getElementById("op-key-status");
      if (statusEl) statusEl.textContent = message || "";
    }

    function hideGate() {
      const gate = document.getElementById("op-gate");
      if (gate) gate.style.display = "none";
    }

    function setText(id, value) {
      const el = document.getElementById(id);
      if (el) el.textContent = value || "-";
    }

    function setLink(id, href) {
      const el = document.getElementById(id);
      if (!el) return;
      el.href = href || "#";
      el.textContent = href || "-";
    }

    function renderDeliverables(deliverables) {
      const list = document.getElementById("deliverables-list");
      const empty = document.getElementById("deliverables-empty");
      if (!list) return;
      list.innerHTML = "";
      const order = ["pack_zip", "scenes_zip", "origin_srt", "mm_srt", "mm_txt", "mm_audio", "edit_bundle_zip"];
      let count = 0;
      order.forEach((key) => {
        const item = deliverables && deliverables[key];
        if (!item || !item.url) return;
        const row = document.createElement("div");
        row.className = "link-row";
        const link = document.createElement("a");
        link.className = "download-link";
        link.href = item.url;
        link.target = "_blank";
        link.rel = "noopener";
        link.textContent = item.label || key;
        row.appendChild(link);
        list.appendChild(row);
        count += 1;
      });
      if (empty) empty.style.display = count ? "none" : "";
    }

    function renderCopyBundle(copy) {
      const captionEl = document.getElementById("copy-caption");
      if (captionEl && !captionEl.value) captionEl.value = copy.caption || "";
      const hashtagsEl = document.getElementById("copy-hashtags");
      if (hashtagsEl && !hashtagsEl.value) hashtagsEl.value = copy.hashtags || "";
      const ctaEl = document.getElementById("copy-comment-cta");
      if (ctaEl && !ctaEl.value) ctaEl.value = copy.comment_cta || "";
      const linkEl = document.getElementById("copy-link-text");
      if (linkEl && !linkEl.value) linkEl.value = copy.link_text || "";
      const timeEl = document.getElementById("copy-publish-time");
      if (timeEl && !timeEl.value) timeEl.value = copy.publish_time_suggestion || "";
    }

    function renderArchive(archive) {
      setText("publish-provider", archive.publish_provider || "-");
      setText("publish-status", archive.publish_status || "-");
      setText("published-at", archive.published_at || "-");
      setText("publish-key", archive.publish_key || "-");
      const urlEl = document.getElementById("publish-url");
      if (urlEl) {
        urlEl.textContent = archive.publish_url || "-";
        urlEl.href = archive.publish_url && archive.publish_url !== "-" ? archive.publish_url : "#";
      }
    }

    function copyTextFromElement(el) {
      if (!el) return;
      let text = "";
      if (el.tagName === "A") {
        text = el.getAttribute("href") || "";
      } else if (el.tagName === "TEXTAREA") {
        text = el.value || "";
      } else {
        text = el.textContent || "";
      }
      if (!text || text === "#") return;
      navigator.clipboard.writeText(text).catch(() => {});
    }

    document.querySelectorAll("[data-copy-target]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const targetId = btn.getAttribute("data-copy-target");
        const target = document.getElementById(targetId);
        copyTextFromElement(target);
      });
    });

    // Lightweight QR generator (qrcode-generator, MIT license)
    (function () {
      function qrcode(typeNumber, errorCorrectionLevel) {
        const PAD0 = 0xec;
        const PAD1 = 0x11;
        const qr = {};
        let modules = null;
        let moduleCount = 0;
        let dataCache = null;
        const dataList = [];
        const RS_BLOCK_TABLE = [
          [1, 26, 19], [1, 26, 16], [1, 26, 13], [1, 26, 9]
        ];
        const QRMath = {
          glog: function (n) {
            if (n < 1) throw new Error("glog");
            return QRMath.LOG_TABLE[n];
          },
          gexp: function (n) {
            while (n < 0) n += 255;
            while (n >= 256) n -= 255;
            return QRMath.EXP_TABLE[n];
          },
          EXP_TABLE: new Array(256),
          LOG_TABLE: new Array(256),
        };
        for (let i = 0; i < 8; i++) QRMath.EXP_TABLE[i] = 1 << i;
        for (let i = 8; i < 256; i++) QRMath.EXP_TABLE[i] = QRMath.EXP_TABLE[i - 4] ^ QRMath.EXP_TABLE[i - 5] ^ QRMath.EXP_TABLE[i - 6] ^ QRMath.EXP_TABLE[i - 8];
        for (let i = 0; i < 255; i++) QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]] = i;
        function QRPolynomial(num, shift) {
          let offset = 0;
          while (offset < num.length && num[offset] === 0) offset++;
          const n = new Array(num.length - offset + shift);
          for (let i = 0; i < num.length - offset; i++) n[i] = num[i + offset];
          return {
            get: function (index) { return n[index]; },
            getLength: function () { return n.length; },
            multiply: function (e) {
              const num = new Array(this.getLength() + e.getLength() - 1).fill(0);
              for (let i = 0; i < this.getLength(); i++) {
                for (let j = 0; j < e.getLength(); j++) {
                  num[i + j] ^= QRMath.gexp(QRMath.glog(this.get(i)) + QRMath.glog(e.get(j)));
                }
              }
              return QRPolynomial(num, 0);
            },
            mod: function (e) {
              if (this.getLength() - e.getLength() < 0) return this;
              const ratio = QRMath.glog(this.get(0)) - QRMath.glog(e.get(0));
              const num = new Array(this.getLength());
              for (let i = 0; i < this.getLength(); i++) num[i] = this.get(i);
              for (let i = 0; i < e.getLength(); i++) {
                num[i] ^= QRMath.gexp(QRMath.glog(e.get(i)) + ratio);
              }
              return QRPolynomial(num, 0).mod(e);
            },
          };
        }
        function getErrorCorrectPolynomial(errorCorrectLength) {
          let a = QRPolynomial([1], 0);
          for (let i = 0; i < errorCorrectLength; i++) {
            a = a.multiply(QRPolynomial([1, QRMath.gexp(i)], 0));
          }
          return a;
        }
        function getRSBlocks(typeNumber, errorCorrectionLevel) {
          const rsBlock = RS_BLOCK_TABLE[errorCorrectionLevel];
          return [{ totalCount: rsBlock[1], dataCount: rsBlock[2] }];
        }
        function BitBuffer() {
          const buffer = [];
          let length = 0;
          return {
            getBuffer: function () { return buffer; },
            getLengthInBits: function () { return length; },
            put: function (num, length_) {
              for (let i = 0; i < length_; i++) this.putBit(((num >>> (length_ - i - 1)) & 1) === 1);
            },
            putBit: function (bit) {
              const bufIndex = Math.floor(length / 8);
              if (buffer.length <= bufIndex) buffer.push(0);
              if (bit) buffer[bufIndex] |= 0x80 >>> (length % 8);
              length++;
            },
          };
        }
        function QR8bitByte(data) {
          const parsed = [];
          for (let i = 0; i < data.length; i++) parsed.push(data.charCodeAt(i));
          return {
            getLength: function () { return parsed.length; },
            write: function (buffer) { for (let i = 0; i < parsed.length; i++) buffer.put(parsed[i], 8); },
          };
        }
        function createData(typeNumber, errorCorrectionLevel, dataList) {
          const rsBlocks = getRSBlocks(typeNumber, errorCorrectionLevel);
          const buffer = BitBuffer();
          for (let i = 0; i < dataList.length; i++) {
            buffer.put(4, 4);
            buffer.put(dataList[i].getLength(), 8);
            dataList[i].write(buffer);
          }
          let totalDataCount = 0;
          for (let i = 0; i < rsBlocks.length; i++) totalDataCount += rsBlocks[i].dataCount;
          if (buffer.getLengthInBits() > totalDataCount * 8) throw new Error("Overflow");
          if (buffer.getLengthInBits() + 4 <= totalDataCount * 8) buffer.put(0, 4);
          while (buffer.getLengthInBits() % 8 !== 0) buffer.putBit(false);
          while (buffer.getBuffer().length < totalDataCount) {
            buffer.put(PAD0, 8);
            if (buffer.getBuffer().length >= totalDataCount) break;
            buffer.put(PAD1, 8);
          }
          return buffer.getBuffer();
        }
        function createBytes(buffer, rsBlocks) {
          let offset = 0;
          const maxDcCount = 0;
          const maxEcCount = 0;
          const dcdata = [];
          const ecdata = [];
          for (let r = 0; r < rsBlocks.length; r++) {
            const dcCount = rsBlocks[r].dataCount;
            const ecCount = rsBlocks[r].totalCount - dcCount;
            dcdata[r] = new Array(dcCount);
            for (let i = 0; i < dcdata[r].length; i++) dcdata[r][i] = 0xff & buffer[i + offset];
            offset += dcCount;
            const rsPoly = getErrorCorrectPolynomial(ecCount);
            const rawPoly = QRPolynomial(dcdata[r], rsPoly.getLength() - 1);
            const modPoly = rawPoly.mod(rsPoly);
            ecdata[r] = new Array(rsPoly.getLength() - 1);
            for (let i = 0; i < ecdata[r].length; i++) {
              const modIndex = i + modPoly.getLength() - ecdata[r].length;
              ecdata[r][i] = modIndex >= 0 ? modPoly.get(modIndex) : 0;
            }
          }
          const totalCodeCount = rsBlocks[0].totalCount;
          const data = [];
          for (let i = 0; i < totalCodeCount; i++) {
            if (i < dcdata[0].length) data.push(dcdata[0][i]);
          }
          for (let i = 0; i < ecdata[0].length; i++) data.push(ecdata[0][i]);
          return data;
        }
        function createMatrix(typeNumber, errorCorrectionLevel, dataList) {
          const size = typeNumber * 4 + 17;
          moduleCount = size;
          modules = new Array(size);
          for (let i = 0; i < size; i++) {
            modules[i] = new Array(size);
            for (let j = 0; j < size; j++) modules[i][j] = null;
          }
          const data = createData(typeNumber, errorCorrectionLevel, dataList);
          const bytes = createBytes(data, getRSBlocks(typeNumber, errorCorrectionLevel));
          let i = 0;
          for (let col = size - 1; col > 0; col -= 2) {
            if (col === 6) col--;
            for (let row = 0; row < size; row++) {
              for (let c = 0; c < 2; c++) {
                const r = row;
                const cl = col - c;
                if (modules[r][cl] === null) {
                  modules[r][cl] = ((bytes[i >> 3] >>> (7 - (i & 7))) & 1) === 1;
                  i++;
                }
              }
            }
          }
        }
        qr.addData = function (data) {
          dataList.push(QR8bitByte(data));
          dataCache = null;
        };
        qr.make = function () {
          createMatrix(1, errorCorrectionLevel, dataList);
        };
        qr.createSvgTag = function (cellSize, margin) {
          const size = moduleCount * cellSize + margin * 2;
          let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">`;
          svg += `<rect width="100%" height="100%" fill="#fff"/>`;
          for (let r = 0; r < moduleCount; r++) {
            for (let c = 0; c < moduleCount; c++) {
              if (modules[r][c]) {
                svg += `<rect x="${c * cellSize + margin}" y="${r * cellSize + margin}" width="${cellSize}" height="${cellSize}" fill="#000"/>`;
              }
            }
          }
          svg += "</svg>";
          return svg;
        };
        return qr;
      }
      window._qrcode = qrcode;
    })();

    function renderQr(text) {
      const box = document.getElementById("qr-box");
      if (!box) return;
      if (!text) {
        box.textContent = "QR unavailable";
        return;
      }
      const qr = window._qrcode(1, 1);
      qr.addData(text);
      qr.make();
      box.innerHTML = qr.createSvgTag(4, 4);
    }

    async function fetchPublishHub() {
      const opKey = getOpKey();
      if (!opKey) {
        showGate("Enter OP access key to continue.");
        return;
      }
      const resp = await fetch(`/api/tasks/${encodeURIComponent(TASK_ID)}/publish_hub`, {
        headers: { "X-OP-KEY": opKey },
      });
      if (resp.status === 401 || resp.status === 403) {
        showGate("Invalid OP access key.");
        return;
      }
      if (!resp.ok) {
        showGate(`Failed to load: HTTP ${resp.status}`);
        return;
      }
      hideGate();
      const data = await resp.json();
      setText("download-code", data.download_code || "-");
      renderDeliverables(data.deliverables || {});
      renderCopyBundle(data.copy_bundle || {});
      renderArchive(data.archive || {});
      const editLink = document.getElementById("edit-bundle-link");
      if (editLink && data.deliverables && data.deliverables.edit_bundle_zip) {
        editLink.href = data.deliverables.edit_bundle_zip.url;
      }
      const sopEl = document.getElementById("sop-markdown");
      if (sopEl) sopEl.textContent = data.sop_markdown || "";
      if (data.mobile && data.mobile.qr_url) {
        renderQr(data.mobile.qr_url);
      }
    }

    const publishBtn = document.getElementById("publish-btn");
    if (publishBtn) {
      publishBtn.addEventListener("click", async () => {
        const statusEl = document.getElementById("publish-status");
        if (statusEl) statusEl.textContent = "Publishing...";
        try {
          const resp = await fetch(`/api/tasks/${encodeURIComponent(TASK_ID)}/publish`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ task_id: TASK_ID, force: false }),
          });
          if (!resp.ok) {
            const detail = await resp.text();
            if (statusEl) statusEl.textContent = `Publish failed: ${resp.status} ${detail}`;
            return;
          }
          if (statusEl) statusEl.textContent = "Published.";
          await fetchPublishHub();
        } catch (err) {
          if (statusEl) statusEl.textContent = `Publish error: ${err}`;
        }
      });
    }

    const saveBtn = document.getElementById("op-key-save");
    if (saveBtn) {
      saveBtn.addEventListener("click", () => {
        const input = document.getElementById("op-key-input");
        const value = input ? input.value.trim() : "";
        if (!value) {
          showGate("OP access key is required.");
          return;
        }
        setOpKey(value);
        fetchPublishHub().catch(() => {});
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const tabs = document.querySelectorAll(".tab-btn");
      const panels = document.querySelectorAll(".tab-panel");
      function activate(id) {
        tabs.forEach((btn) => btn.classList.toggle("active", btn.dataset.tab === id));
        panels.forEach((panel) => panel.classList.toggle("active", panel.id === id));
      }
      tabs.forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.tab;
          if (id) activate(id);
        });
      });
      const hash = window.location.hash.replace("#", "");
      if (hash) activate(`tab-${hash}`);
      fetchPublishHub().catch(() => {});
    });
  </script>
</body>
</html>
